<!-- src/app/alerts/alert-dashboard/alert-dashboard.component.html -->
<!-- üö® ALERT DASHBOARD TEMPLATE - FILTROS DE FECHA CORREGIDOS -->

<div class="alert-dashboard">
  <!-- ‚úÖ HEADER CON NAVEGACI√ìN -->
  <div class="dashboard-header">
    <div class="header-content">
      <button mat-icon-button (click)="goBack()" class="back-button">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <div class="header-text">
        <h1>
          <mat-icon>notification_important</mat-icon>
          Centro de Alertas Cr√≠ticas
        </h1>
        <p>Supervisi√≥n en tiempo real de errores posturales cr√≠ticos</p>
      </div>
      <div class="header-actions">
        <button mat-button (click)="exportAlerts()" class="action-btn">
          <mat-icon>download</mat-icon>
          Exportar
        </button>
        <button mat-button (click)="openSettings()" class="action-btn">
          <mat-icon>settings</mat-icon>
          Configurar
        </button>
      </div>
    </div>
  </div>

  <!-- ‚úÖ LOADING SPINNER -->
  <div class="loading-container" *ngIf="isLoading">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Cargando alertas cr√≠ticas...</p>
  </div>

  <!-- ‚úÖ CONTENIDO PRINCIPAL -->
  <div class="dashboard-content" *ngIf="!isLoading">

    <!-- ‚úÖ M√âTRICAS PRINCIPALES -->
    <div class="metrics-section" *ngIf="alertMetrics">
      <mat-card class="metric-card total">
        <div class="metric-content">
          <div class="metric-icon">
            <mat-icon [matBadge]="alertMetrics.totalAlerts" matBadgeColor="primary">notifications</mat-icon>
          </div>
          <div class="metric-info">
            <h3>{{ alertMetrics.totalAlerts }}</h3>
            <span>Total de Alertas</span>
          </div>
        </div>
      </mat-card>

      <mat-card class="metric-card critical">
        <div class="metric-content">
          <div class="metric-icon">
            <mat-icon [matBadge]="alertMetrics.criticalAlerts" matBadgeColor="warn">error</mat-icon>
          </div>
          <div class="metric-info">
            <h3>{{ alertMetrics.criticalAlerts }}</h3>
            <span>Cr√≠ticas</span>
          </div>
        </div>
      </mat-card>

      <mat-card class="metric-card unread">
        <div class="metric-content">
          <div class="metric-icon">
            <mat-icon [matBadge]="alertMetrics.unreadAlerts" matBadgeColor="warn">mark_email_unread</mat-icon>
          </div>
          <div class="metric-info">
            <h3>{{ alertMetrics.unreadAlerts }}</h3>
            <span>Sin Leer</span>
          </div>
        </div>
      </mat-card>

      <mat-card class="metric-card today">
        <div class="metric-content">
          <div class="metric-icon">
            <mat-icon [matBadge]="alertMetrics.alertsToday" matBadgeColor="accent">today</mat-icon>
          </div>
          <div class="metric-info">
            <h3>{{ alertMetrics.alertsToday }}</h3>
            <span>Hoy</span>
          </div>
        </div>
      </mat-card>

      <mat-card class="metric-card response-time">
        <div class="metric-content">
          <div class="metric-icon">
            <mat-icon>schedule</mat-icon>
          </div>
          <div class="metric-info">
            <h3>{{ alertMetrics.responseTime }}min</h3>
            <span>Tiempo de Respuesta</span>
          </div>
        </div>
      </mat-card>
    </div>

    <!-- ‚úÖ FILTROS CORREGIDOS -->
    <mat-card class="filters-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>filter_list</mat-icon>
          Filtros de B√∫squeda
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <form [formGroup]="filterForm" class="filter-form">
          <div class="filter-row">
            <!-- Filtro por Severidad -->
            <mat-form-field appearance="outline">
              <mat-label>Severidad</mat-label>
              <mat-select formControlName="severity">
                <mat-option *ngFor="let option of severityOptions" [value]="option.value">
                  <mat-icon [style.color]="option.color || '#666'">{{ option.icon }}</mat-icon>
                  {{ option.label }}
                </mat-option>
              </mat-select>
            </mat-form-field>

            <!-- Filtro por Estado -->
            <mat-form-field appearance="outline">
              <mat-label>Estado</mat-label>
              <mat-select formControlName="status">
                <mat-option *ngFor="let option of statusOptions" [value]="option.value">
                  <mat-icon [style.color]="option.color || '#666'">{{ option.icon }}</mat-icon>
                  {{ option.label }}
                </mat-option>
              </mat-select>
            </mat-form-field>

            <!-- Filtro por Tipo de Error -->
            <mat-form-field appearance="outline" *ngIf="errorTypes.length > 0">
              <mat-label>Tipo de Error</mat-label>
              <mat-select formControlName="errorType">
                <mat-option value="">Todos los tipos</mat-option>
                <mat-option *ngFor="let errorType of errorTypes" [value]="errorType">
                  {{ getErrorTypeLabel(errorType) }}
                </mat-option>
              </mat-select>
            </mat-form-field>

            <!-- Limpiar Filtros -->
            <button mat-raised-button 
                    color="accent" 
                    (click)="clearAllFilters()"
                    class="clear-filters-btn">
              <mat-icon>clear_all</mat-icon>
              Limpiar
            </button>
          </div>

          <!-- ‚úÖ FILTROS DE FECHA CORREGIDOS CON DATEPICKER -->
          <div class="filter-row">
            <mat-form-field appearance="outline">
              <mat-label>Fecha Inicio</mat-label>
              <input matInput [matDatepicker]="startPicker" formControlName="dateStart" placeholder="Seleccionar fecha">
              <mat-datepicker-toggle matIconSuffix [for]="startPicker"></mat-datepicker-toggle>
              <mat-datepicker #startPicker></mat-datepicker>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Fecha Fin</mat-label>
              <input matInput [matDatepicker]="endPicker" formControlName="dateEnd" placeholder="Seleccionar fecha">
              <mat-datepicker-toggle matIconSuffix [for]="endPicker"></mat-datepicker-toggle>
              <mat-datepicker #endPicker></mat-datepicker>
            </mat-form-field>

            <!-- Filtros r√°pidos de fecha -->
            <div class="quick-date-filters">
              <button mat-button (click)="setQuickDateFilter('today')" class="quick-date-btn">
                <mat-icon>today</mat-icon>
                Hoy
              </button>
              <button mat-button (click)="setQuickDateFilter('week')" class="quick-date-btn">
                <mat-icon>date_range</mat-icon>
                Esta semana
              </button>
              <button mat-button (click)="setQuickDateFilter('month')" class="quick-date-btn">
                <mat-icon>calendar_month</mat-icon>
                Este mes
              </button>
            </div>
          </div>
        </form>
      </mat-card-content>
    </mat-card>

    <!-- ‚úÖ GR√ÅFICOS ANAL√çTICOS -->
    <div class="charts-section">
      <mat-card class="chart-card">
        <mat-card-header>
          <mat-card-title>Distribuci√≥n por Severidad</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="chart-container">
            <canvas #severityChart></canvas>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="chart-card">
        <mat-card-header>
          <mat-card-title>Tendencia Temporal</mat-card-title>
          <mat-card-subtitle>Alertas en los √∫ltimos 7 d√≠as</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <div class="chart-container">
            <canvas #timelineChart></canvas>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="chart-card wide">
        <mat-card-header>
          <mat-card-title>Tipos de Errores M√°s Frecuentes</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="chart-container">
            <canvas #errorTypesChart></canvas>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- ‚úÖ ALERTAS RECIENTES -->
    <mat-card class="recent-alerts-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon [matBadge]="recentAlerts.length" matBadgeColor="warn">schedule</mat-icon>
          Alertas M√°s Recientes
        </mat-card-title>
        <mat-card-subtitle>√öltimas 10 alertas cr√≠ticas</mat-card-subtitle>
        <div class="spacer"></div>
        <button mat-button color="primary" (click)="viewAllAlerts()">
          Ver Todas
          <mat-icon>arrow_forward</mat-icon>
        </button>
      </mat-card-header>
      <mat-card-content>
        <div class="alerts-list" *ngIf="recentAlerts.length > 0; else noAlerts">
          <div class="alert-item" 
               *ngFor="let alert of recentAlerts" 
               [class.unread]="alert.status === 'unread'"
               (click)="viewAlertDetail(alert)">
            
            <div class="alert-severity" [class]="'severity-' + alert.severity">
              <mat-icon [style.color]="getSeverityColor(alert.severity)">
                {{ getSeverityIcon(alert.severity) }}
              </mat-icon>
            </div>

            <div class="alert-info">
              <div class="alert-user">{{ alert.userDisplayName }}</div>
              <div class="alert-error">{{ getErrorTypeLabel(alert.errorType) }}</div>
              <div class="alert-exercise">{{ alert.exercise }}</div>
            </div>

            <div class="alert-status">
              <mat-chip [style.background-color]="getStatusColor(alert.status)" 
                        [style.color]="'white'">
                <mat-icon [style.color]="'white'">{{ getStatusIcon(alert.status) }}</mat-icon>
                {{ alert.status === 'unread' ? 'Sin leer' : alert.status === 'read' ? 'Le√≠da' : 'Resuelta' }}
              </mat-chip>
            </div>

            <div class="alert-time">
              <span>{{ formatTime(alert.processedAt) }}</span>
              <div class="alert-actions">
                <button mat-icon-button 
                        *ngIf="alert.status === 'unread'"
                        (click)="markAsRead(alert); $event.stopPropagation()"
                        matTooltip="Marcar como le√≠da">
                  <mat-icon>mark_email_read</mat-icon>
                </button>
                <button mat-icon-button 
                        *ngIf="alert.status !== 'resolved'"
                        (click)="resolveAlert(alert); $event.stopPropagation()"
                        matTooltip="Resolver alerta">
                  <mat-icon>check_circle</mat-icon>
                </button>
                <button mat-icon-button 
                        (click)="viewAlertDetail(alert); $event.stopPropagation()"
                        matTooltip="Ver detalle">
                  <mat-icon>visibility</mat-icon>
                </button>
              </div>
            </div>
          </div>
        </div>

        <ng-template #noAlerts>
          <div class="no-alerts">
            <mat-icon>check_circle</mat-icon>
            <h3>No hay alertas cr√≠ticas</h3>
            <p>Todos los usuarios est√°n entrenando correctamente</p>
          </div>
        </ng-template>
      </mat-card-content>
    </mat-card>

    <!-- ‚úÖ TABLA COMPLETA DE ALERTAS -->
    <mat-card class="table-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>list</mat-icon>
          Todas las Alertas 
          <span class="results-count">({{ filteredAlerts.length }} resultados)</span>
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="table-container">
          <table mat-table [dataSource]="dataSource" matSort class="alerts-table">
            
            <!-- Columna Severidad -->
            <ng-container matColumnDef="severity">
              <th mat-header-cell *matHeaderCellDef mat-sort-header="severity">Severidad</th>
              <td mat-cell *matCellDef="let alert">
                <div class="severity-cell">
                  <mat-icon [style.color]="getSeverityColor(alert.severity)">
                    {{ getSeverityIcon(alert.severity) }}
                  </mat-icon>
                  <span>{{ alert.severity }}</span>
                </div>
              </td>
            </ng-container>

            <!-- Columna Usuario -->
            <ng-container matColumnDef="user">
              <th mat-header-cell *matHeaderCellDef mat-sort-header="userDisplayName">Usuario</th>
              <td mat-cell *matCellDef="let alert">
                <div class="user-cell">
                  <strong>{{ alert.userDisplayName }}</strong>
                  <small>{{ alert.userEmail }}</small>
                </div>
              </td>
            </ng-container>

            <!-- Columna Tipo de Error -->
            <ng-container matColumnDef="errorType">
              <th mat-header-cell *matHeaderCellDef mat-sort-header="errorType">Tipo de Error</th>
              <td mat-cell *matCellDef="let alert">
                {{ getErrorTypeLabel(alert.errorType) }}
              </td>
            </ng-container>

            <!-- Columna Ejercicio -->
            <ng-container matColumnDef="exercise">
              <th mat-header-cell *matHeaderCellDef mat-sort-header="exercise">Ejercicio</th>
              <td mat-cell *matCellDef="let alert">{{ alert.exercise }}</td>
            </ng-container>

            <!-- Columna Tiempo -->
            <ng-container matColumnDef="time">
              <th mat-header-cell *matHeaderCellDef mat-sort-header="processedAt">Fecha/Hora</th>
              <td mat-cell *matCellDef="let alert">{{ formatTime(alert.processedAt) }}</td>
            </ng-container>

            <!-- Columna Estado -->
            <ng-container matColumnDef="status">
              <th mat-header-cell *matHeaderCellDef mat-sort-header="status">Estado</th>
              <td mat-cell *matCellDef="let alert">
                <mat-chip [style.background-color]="getStatusColor(alert.status)" 
                          [style.color]="'white'">
                  {{ alert.status === 'unread' ? 'Sin leer' : alert.status === 'read' ? 'Le√≠da' : 'Resuelta' }}
                </mat-chip>
              </td>
            </ng-container>

            <!-- Columna Acciones -->
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef>Acciones</th>
              <td mat-cell *matCellDef="let alert">
                <div class="table-actions">
                  <button mat-icon-button 
                          *ngIf="alert.status === 'unread'"
                          (click)="markAsRead(alert)"
                          matTooltip="Marcar como le√≠da">
                    <mat-icon>mark_email_read</mat-icon>
                  </button>
                  <button mat-icon-button 
                          *ngIf="alert.status !== 'resolved'"
                          (click)="resolveAlert(alert)"
                          matTooltip="Resolver">
                    <mat-icon>check_circle</mat-icon>
                  </button>
                  <button mat-icon-button 
                          (click)="viewAlertDetail(alert)"
                          matTooltip="Ver detalle">
                    <mat-icon>visibility</mat-icon>
                  </button>
                </div>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row 
                *matRowDef="let row; columns: displayedColumns;"
                [class.unread-row]="row.status === 'unread'"
                (click)="viewAlertDetail(row)">
            </tr>
          </table>

          <!-- Paginaci√≥n -->
          <mat-paginator 
            [pageSizeOptions]="[10, 25, 50, 100]"
            [pageSize]="25"
            showFirstLastButtons>
          </mat-paginator>
        </div>
      </mat-card-content>
    </mat-card>

  </div>
</div>