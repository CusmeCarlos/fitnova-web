<!-- src/app/alerts/alert-dashboard/alert-dashboard.component.html -->
<!-- üö® ALERT DASHBOARD ULTRA PREMIUM - NIVEL FINZENAPP EXACTO -->

<div class="alert-dashboard-container">
  
  <!-- ‚úÖ HEADER ULTRA PREMIUM CON GLASSMORPHISM -->
  <div class="premium-header">
    <div class="header-content">
      <div class="header-left">
        <button mat-icon-button class="back-btn-premium" (click)="goBack()">
          <mat-icon>arrow_back</mat-icon>
        </button>
        
        <div class="header-info">
          <h1 class="premium-title">
            <mat-icon class="title-icon">security</mat-icon>
            Centro de Alertas Cr√≠ticas
          </h1>
          <p class="premium-subtitle">Supervisi√≥n biomec√°nica en tiempo real</p>
        </div>
      </div>
      
      <div class="header-actions">
        <button mat-stroked-button class="action-btn-premium" (click)="exportAlerts()">
          <mat-icon>file_download</mat-icon>
          <span>Exportar</span>
        </button>
      </div>
    </div>
  </div>

  <!-- ‚úÖ LOADING STATE PREMIUM -->
  <div class="loading-state-premium" *ngIf="isLoading">
    <div class="loading-content">
      <div class="loading-spinner">
        <mat-spinner diameter="60"></mat-spinner>
      </div>
      <h3>Cargando alertas cr√≠ticas...</h3>
      <p>Analizando datos biomec√°nicos</p>
    </div>
  </div>

  <!-- ‚úÖ CONTENIDO PRINCIPAL PREMIUM -->
  <div class="dashboard-content-premium" *ngIf="!isLoading">
    
    <!-- üìä M√âTRICAS ULTRA PREMIUM -->
    <div class="metrics-grid-premium" *ngIf="alertMetrics">
      
      <!-- Card 1: Total Alertas -->
      <div class="metric-card-premium total-alerts">
        <div class="metric-header">
          <div class="metric-icon-container">
            <mat-icon class="metric-icon">notifications_active</mat-icon>
          </div>
          <div class="metric-badge">{{ alertMetrics.totalAlerts }}</div>
        </div>
        <div class="metric-content">
          <h3 class="metric-value">{{ alertMetrics.totalAlerts }}</h3>
          <p class="metric-label">Total de Alertas</p>
          <div class="metric-trend positive">
            <mat-icon>trending_up</mat-icon>
            <span>+{{ alertMetrics.alertsToday }} hoy</span>
          </div>
        </div>
        <div class="metric-background"></div>
      </div>

      <!-- Card 2: Alertas Cr√≠ticas -->
      <div class="metric-card-premium critical-alerts">
        <div class="metric-header">
          <div class="metric-icon-container">
            <mat-icon class="metric-icon">error</mat-icon>
          </div>
          <div class="metric-badge critical">{{ alertMetrics.criticalAlerts }}</div>
        </div>
        <div class="metric-content">
          <h3 class="metric-value">{{ alertMetrics.criticalAlerts }}</h3>
          <p class="metric-label">Alertas Cr√≠ticas</p>
          <div class="metric-trend negative">
            <mat-icon>warning</mat-icon>
            <span>Requieren atenci√≥n</span>
          </div>
        </div>
        <div class="metric-background"></div>
      </div>

      <!-- Card 3: Sin Leer -->
      <div class="metric-card-premium unread-alerts">
        <div class="metric-header">
          <div class="metric-icon-container">
            <mat-icon class="metric-icon">mark_email_unread</mat-icon>
          </div>
          <div class="metric-badge warning">{{ alertMetrics.unreadAlerts }}</div>
        </div>
        <div class="metric-content">
          <h3 class="metric-value">{{ alertMetrics.unreadAlerts }}</h3>
          <p class="metric-label">Sin Leer</p>
          <div class="metric-trend neutral">
            <mat-icon>schedule</mat-icon>
            <span>Pendientes</span>
          </div>
        </div>
        <div class="metric-background"></div>
      </div>
    </div>

    <!-- üîç FILTROS COMPACTOS -->
    <div class="filters-section-compact">
      <form [formGroup]="filterForm" class="filters-form-compact">
        <div class="filters-row">

          <!-- Severidad -->
          <mat-form-field appearance="outline" class="filter-compact" subscriptSizing="dynamic">
            <mat-label>Severidad</mat-label>
            <mat-select formControlName="severity">
              <mat-option *ngFor="let option of severityOptions" [value]="option.value">
                <div class="select-option">
                  <mat-icon [style.color]="option.color">{{ option.icon }}</mat-icon>
                  <span>{{ option.label }}</span>
                </div>
              </mat-option>
            </mat-select>
          </mat-form-field>

          <!-- Estado -->
          <mat-form-field appearance="outline" class="filter-compact" subscriptSizing="dynamic">
            <mat-label>Estado</mat-label>
            <mat-select formControlName="status">
              <mat-option *ngFor="let option of statusOptions" [value]="option.value">
                <div class="select-option">
                  <mat-icon [style.color]="option.color">{{ option.icon }}</mat-icon>
                  <span>{{ option.label }}</span>
                </div>
              </mat-option>
            </mat-select>
          </mat-form-field>

          <!-- Tipo de Error -->
          <mat-form-field appearance="outline" class="filter-compact" subscriptSizing="dynamic">
            <mat-label>Tipo de Error</mat-label>
            <mat-select formControlName="errorType">
              <mat-option value="">Todos los tipos</mat-option>
              <mat-option *ngFor="let errorType of errorTypes" [value]="errorType">
                {{ getErrorTypeLabel(errorType) }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <!-- Fecha Inicio -->
          <mat-form-field appearance="outline" class="filter-compact date-filter" subscriptSizing="dynamic">
            <mat-label>Fecha Inicio</mat-label>
            <input matInput [matDatepicker]="startPicker" formControlName="dateStart">
            <mat-datepicker-toggle matIconSuffix [for]="startPicker"></mat-datepicker-toggle>
            <mat-datepicker #startPicker></mat-datepicker>
          </mat-form-field>

          <!-- Fecha Fin -->
          <mat-form-field appearance="outline" class="filter-compact date-filter" subscriptSizing="dynamic">
            <mat-label>Fecha Fin</mat-label>
            <input matInput [matDatepicker]="endPicker" formControlName="dateEnd">
            <mat-datepicker-toggle matIconSuffix [for]="endPicker"></mat-datepicker-toggle>
            <mat-datepicker #endPicker></mat-datepicker>
          </mat-form-field>

          <!-- B√∫squeda -->
          <mat-form-field appearance="outline" class="filter-compact search-filter" subscriptSizing="dynamic">
            <mat-label>Buscar</mat-label>
            <input matInput placeholder="Usuario o ejercicio..." formControlName="searchTerm">
            <mat-icon matIconSuffix>search</mat-icon>
          </mat-form-field>

          <!-- Bot√≥n Limpiar -->
          <button mat-icon-button class="clear-filters-btn" (click)="clearAllFilters()" matTooltip="Limpiar todos los filtros">
            <mat-icon>clear_all</mat-icon>
          </button>
        </div>
      </form>
    </div>

    <!-- üìä GR√ÅFICOS ULTRA PREMIUM -->
    <div class="charts-section-premium">
      
      <!-- Gr√°fico Severidad -->
      <div class="chart-card-premium">
        <div class="chart-header">
          <h3>
            <mat-icon>pie_chart</mat-icon>
            Distribuci√≥n por Severidad
          </h3>
          <div class="chart-actions">
            <button mat-icon-button matTooltip="Actualizar">
              <mat-icon>refresh</mat-icon>
            </button>
          </div>
        </div>
        <div class="chart-container">
          <canvas #severityChart></canvas>
        </div>
      </div>

      <!-- Gr√°fico Timeline -->
      <div class="chart-card-premium">
        <div class="chart-header">
          <h3>
            <mat-icon>timeline</mat-icon>
            Tendencia Temporal
          </h3>
          <div class="chart-actions">
            <button mat-icon-button matTooltip="Actualizar">
              <mat-icon>refresh</mat-icon>
            </button>
          </div>
        </div>
        <div class="chart-container">
          <canvas #timelineChart></canvas>
        </div>
      </div>

      <!-- Gr√°fico Tipos de Error -->
      <div class="chart-card-premium">
        <div class="chart-header">
          <h3>
            <mat-icon>bar_chart</mat-icon>
            Errores M√°s Frecuentes
          </h3>
          <div class="chart-actions">
            <button mat-icon-button matTooltip="Actualizar">
              <mat-icon>refresh</mat-icon>
            </button>
          </div>
        </div>
        <div class="chart-container">
          <canvas #errorTypesChart></canvas>
        </div>
      </div>
    </div>

    <!-- üìã LISTA DE ALERTAS PREMIUM (IGUAL QUE ROUTINE-VALIDATION) -->
    <div class="alerts-section-premium">
      <div class="alerts-card-premium">
        <div class="alerts-header">
          <h2>
            <mat-icon>notification_important</mat-icon>
            Alertas Cr√≠ticas Recientes
            <span class="results-count">({{ filteredAlerts.length }} alertas)</span>
          </h2>
          <div class="alerts-actions">
            <button mat-stroked-button class="export-btn-premium" (click)="exportAlerts()">
              <mat-icon>file_download</mat-icon>
              Exportar CSV
            </button>
          </div>
        </div>

        <!-- Lista Premium de Alertas -->
        <div class="alerts-list-container" *ngIf="filteredAlerts.length > 0; else emptyAlerts">
          <div class="alert-item-premium" 
               *ngFor="let alert of filteredAlerts; let i = index" 
               [class.unread-alert]="alert.status === 'unread'"
               (click)="viewAlertDetail(alert)">
            
            <!-- Severidad Premium -->
            <div class="alert-severity-section">
              <div class="severity-badge" [class]="'severity-' + alert.severity">
                <mat-icon [style.color]="getSeverityColor(alert.severity)">
                  {{ getSeverityIcon(alert.severity) }}
                </mat-icon>
              </div>
              <div class="severity-details">
                <span class="severity-label">{{ alert.severity | titlecase }}</span>
                <div class="confidence-indicator">
                  <div class="confidence-bar">
                    <div class="confidence-fill" [style.width.%]="alert.confidence * 100"></div>
                  </div>
                  <small>{{ (alert.confidence * 100) | number:'1.0-0' }}%</small>
                </div>
              </div>
            </div>

            <!-- Informaci√≥n del Usuario -->
            <div class="alert-user-section">
              <div class="user-avatar-premium">
                <mat-icon>person</mat-icon>
              </div>
              <div class="user-details">
                <span class="user-name">{{ alert.userDisplayName || 'Usuario' }}</span>
                <small class="user-email">{{ alert.userEmail || alert.uid }}</small>
              </div>
            </div>

            <!-- Error y Ejercicio -->
            <div class="alert-error-section">
              <div class="error-type-premium">{{ getErrorTypeLabel(alert.errorType) }}</div>
              <div class="exercise-name">{{ alert.exercise }}</div>
            </div>

            <!-- Captura Autom√°tica - SOLO INDICADOR -->
            <div class="alert-capture-section" *ngIf="alert.captureURL">
              <div class="capture-indicator">
                <div class="capture-icon-container" (click)="viewCaptureFullscreen(alert.captureURL)">
                  <mat-icon class="capture-icon">camera_alt</mat-icon>
                  <div class="capture-overlay">
                    <mat-icon>visibility</mat-icon>
                    <span>Ver captura</span>
                  </div>
                </div>
                <div class="capture-info">
                  <button mat-button 
                          class="view-capture-btn"
                          (click)="viewCaptureFullscreen(alert.captureURL)">
                    
                  </button>
                </div>
              </div>
            </div>

            <!-- Sin Captura (para errores no cr√≠ticos) -->
            <div class="alert-no-capture-section" *ngIf="!alert.captureURL">
              <div class="no-capture-placeholder">
                <mat-icon>photo_camera</mat-icon>
                <small>Sin captura</small>
              </div>
            </div>

            <!-- Fecha y Tiempo -->
            <div class="alert-time-section">
              <div class="timestamp-main">{{ formatTime(alert.timestamp.toDate ? alert.timestamp.toDate() : alert.timestamp) }}</div>
              <div class="timestamp-relative">{{ getTimeAgo(alert.timestamp.toDate ? alert.timestamp.toDate() : alert.timestamp) }}</div>
            </div>

            <!-- Estado -->
            <div class="alert-status-section">
              <mat-chip class="status-chip-premium" [class]="'status-' + alert.status">
                <mat-icon>{{ getStatusIcon(alert.status) }}</mat-icon>
                <span>{{ getStatusLabel(alert.status) }}</span>
              </mat-chip>
            </div>

            <!-- Acciones -->
            <div class="alert-actions-section">
              <button mat-icon-button 
                      class="action-btn-premium view"
                      matTooltip="Ver detalles"
                      (click)="$event.stopPropagation(); viewAlertDetail(alert)">
                <mat-icon>visibility</mat-icon>
              </button>
              
              <button mat-icon-button 
                      class="action-btn-premium read"
                      matTooltip="Marcar como le√≠da"
                      *ngIf="alert.status === 'unread'"
                      (click)="$event.stopPropagation(); markAsRead(alert)">
                <mat-icon>mark_email_read</mat-icon>
              </button>
              
              <button mat-icon-button 
                      class="action-btn-premium resolve"
                      matTooltip="Resolver alerta"
                      *ngIf="alert.status !== 'resolved'"
                      (click)="$event.stopPropagation(); resolveAlert(alert)">
                <mat-icon>check_circle</mat-icon>
              </button>
            </div>

            <!-- Indicador de nueva alerta -->
            <div class="new-alert-indicator" *ngIf="alert.status === 'unread'"></div>
          </div>
        </div>

        <!-- Estado vac√≠o premium -->
        <ng-template #emptyAlerts>
          <div class="empty-alerts-premium">
            <div class="empty-content">
              <mat-icon class="empty-icon">security</mat-icon>
              <h3>¬°Excelente trabajo!</h3>
              <p>No hay alertas cr√≠ticas. Todos los usuarios est√°n entrenando correctamente.</p>
              <button mat-stroked-button class="clear-filters-btn" (click)="clearAllFilters()">
                <mat-icon>refresh</mat-icon>
                Actualizar Vista
              </button>
            </div>
          </div>
        </ng-template>

        <!-- Paginador Premium -->
        <div class="pagination-section" *ngIf="filteredAlerts.length > 0">
          <mat-paginator [pageSizeOptions]="[10, 25, 50, 100]" 
                         [pageSize]="25"
                         [showFirstLastButtons]="true"
                         class="paginator-premium">
          </mat-paginator>
        </div>
      </div>
    </div>
  </div>
</div>