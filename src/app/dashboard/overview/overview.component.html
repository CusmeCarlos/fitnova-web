<!-- src/app/dashboard/overview/overview.component.html -->
<!-- üìä DASHBOARD PREMIUM - SIN HEADER REDUNDANTE -->

<div class="dashboard-container">

  <!-- ‚úÖ LOADING STATE -->
  <div class="loading-container" *ngIf="isLoading">
    <div class="loading-content">
      <mat-spinner diameter="50"></mat-spinner>
      <p>Cargando m√©tricas del gimnasio...</p>
    </div>
  </div>

  <!-- ‚úÖ CONTENIDO PRINCIPAL -->
  <div class="dashboard-content" *ngIf="!isLoading && globalMetrics">

    <!-- ‚úÖ M√âTRICAS PRINCIPALES -->
    <div class="metrics-section">
      <h3 class="fade-in-up">
        <mat-icon>dashboard</mat-icon>
        Resumen de Entrenamiento
      </h3>
      
      <div class="metrics-grid">
        
        <!-- Total Usuarios -->
        <div class="metric-card users-card fade-in-up stagger-1">
          <div class="metric-header">
            <div class="metric-info">
              <div class="metric-title">Total Usuarios</div>
              <div class="metric-subtitle">Registrados en la plataforma</div>
            </div>
            <div class="metric-icon">
              <mat-icon>people</mat-icon>
            </div>
          </div>
          <div class="metric-value">{{formatNumber(globalMetrics.totalUsers)}}</div>
          <div class="metric-change positive">
            <mat-icon class="change-icon">trending_up</mat-icon>
            <span>{{globalMetrics.activeUsersToday}} activos hoy</span>
          </div>
        </div>

        <!-- Entrenamientos Hoy -->
        <div class="metric-card training-card fade-in-up stagger-2">
          <div class="metric-header">
            <div class="metric-info">
              <div class="metric-title">Entrenamientos Hoy</div>
              <div class="metric-subtitle">Sesiones completadas</div>
            </div>
            <div class="metric-icon">
              <mat-icon>fitness_center</mat-icon>
            </div>
          </div>
          <div class="metric-value">{{formatNumber(globalMetrics.totalWorkoutsToday)}}</div>
          <div class="metric-change positive">
            <mat-icon class="change-icon">arrow_upward</mat-icon>
            <span>{{formatNumber(globalMetrics.totalWorkoutsAllTime)}} totales</span>
          </div>
        </div>

        <!-- üÜï Errores Reducidos Esta Semana -->
        <div class="metric-card error-reduction-card fade-in-up stagger-3">
          <div class="metric-header">
            <div class="metric-info">
              <div class="metric-title">Errores Reducidos</div>
              <div class="metric-subtitle">Esta semana</div>
            </div>
            <div class="metric-icon">
              <mat-icon>trending_down</mat-icon>
            </div>
          </div>
          <div class="metric-value">
            {{globalMetrics.errorReductionMetrics?.totalErrorsReducedThisWeek || 0}}
          </div>
          <div class="metric-change positive">
            <mat-icon class="change-icon">check_circle</mat-icon>
            <span>Errores corregidos</span>
          </div>
        </div>

        <!-- Errores Cr√≠ticos -->
        <div class="metric-card errors-card fade-in-up stagger-4">
          <div class="metric-header">
            <div class="metric-info">
              <div class="metric-title">Errores Cr√≠ticos</div>
              <div class="metric-subtitle">Detectados hoy</div>
            </div>
            <div class="metric-icon">
              <mat-icon>warning</mat-icon>
            </div>
          </div>
          <div class="metric-value">{{formatNumber(globalMetrics.criticalErrorsToday)}}</div>
          <div class="metric-change" [class]="globalMetrics.criticalErrorsToday === 0 ? 'positive' : 'negative'">
            <mat-icon class="change-icon">
              {{globalMetrics.criticalErrorsToday === 0 ? 'check_circle' : 'warning'}}
            </mat-icon>
            <span>{{globalMetrics.criticalErrorsToday === 0 ? 'Sin errores' : 'Requiere atenci√≥n'}}</span>
          </div>
        </div>

        <!-- üÜï Ejercicios Mejorados Esta Semana -->
        <div class="metric-card exercises-improved-card fade-in-up stagger-5">
          <div class="metric-header">
            <div class="metric-info">
              <div class="metric-title">Ejercicios Mejorados</div>
              <div class="metric-subtitle">Con 2 sesiones esta semana</div>
            </div>
            <div class="metric-icon">
              <mat-icon>psychology</mat-icon>
            </div>
          </div>
          <div class="metric-value">
            {{globalMetrics.errorReductionMetrics?.totalExercisesImprovedThisWeek || 0}}
          </div>
          <div class="metric-change positive">
            <mat-icon class="change-icon">star</mat-icon>
            <span>Progreso registrado</span>
          </div>
        </div>

      </div>
    </div>

    <!-- ‚úÖ ACCIONES R√ÅPIDAS -->
    <div class="quick-actions-section fade-in-up">
      <h3>
        <mat-icon>bolt</mat-icon>
        Acciones R√°pidas
      </h3>
      
      <div class="actions-grid">
        <a class="action-card" (click)="navigateToUserManagement()">
          <div class="action-icon">
            <mat-icon>people</mat-icon>
          </div>
          <span class="action-text">Gestionar Usuarios</span>
        </a>

        <a class="action-card" (click)="navigateToRoutines()">
          <div class="action-icon">
            <mat-icon>assignment</mat-icon>
          </div>
          <span class="action-text">Validar Rutinas IA</span>
        </a>

        <a class="action-card" (click)="navigateToAlerts()">
          <div class="action-icon">
            <mat-icon>notification_important</mat-icon>
          </div>
          <span class="action-text">Centro de Alertas</span>
        </a>

        <a class="action-card" (click)="navigateToAnalytics()">
          <div class="action-icon">
            <mat-icon>analytics</mat-icon>
          </div>
          <span class="action-text">Analytics Avanzado</span>
        </a>
      </div>
    </div>

    <!-- ‚úÖ SECCI√ìN DE PROGRESO -->
    <div class="progress-section fade-in-up" *ngIf="!showUserDetail">
      <div class="progress-header">
        <h3>
          <mat-icon>trending_up</mat-icon>
          Progreso de Usuarios
        </h3>
        <a href="#" class="view-all-btn" (click)="navigateToAnalytics()">Ver todo</a>
      </div>

      <div class="progress-list">
        <div class="progress-item" *ngFor="let user of allUsers.slice(0, 3)">
          <div class="progress-info">
            <div class="progress-name">{{user.displayName}}</div>
            <div class="progress-detail">{{user.totalWorkouts || 0}} entrenamientos completados</div>
          </div>
          <div class="progress-stats">
            <div class="stat-item">
              <mat-icon>trending_down</mat-icon>
              <span class="stat-value">{{user.errorsReduced || 0}}</span>
              <span class="stat-label">errores reducidos</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚úÖ SELECTOR DE USUARIO -->
    <mat-card class="user-selector-card fade-in-up" *ngIf="!showUserDetail">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>person_search</mat-icon>
          Vista Detallada por Usuario
        </mat-card-title>
        <mat-card-subtitle>Selecciona un usuario para ver sus m√©tricas espec√≠ficas</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <mat-form-field appearance="outline" class="user-select-field">
          <mat-label>Seleccionar Usuario</mat-label>
          <mat-select [value]="selectedUserId"
                      (selectionChange)="onUserSelected($event.value)"
                      placeholder="Elige un usuario...">
            <mat-option value="">-- Ver m√©tricas globales --</mat-option>
            <mat-option *ngFor="let user of allUsers" [value]="user.uid">
              {{user.displayName}} ({{user.totalWorkouts || 0}} entrenamientos)
            </mat-option>
          </mat-select>
        </mat-form-field>
      </mat-card-content>
    </mat-card>

    <!-- ‚úÖ VISTA DETALLADA DEL USUARIO -->
    <div class="user-detail-section fade-in-up" *ngIf="showUserDetail">
      
      <!-- Loading del usuario -->
      <div class="user-loading" *ngIf="isLoadingUserDetail">
        <mat-card>
          <mat-card-content>
            <div class="loading-content">
              <mat-spinner diameter="30"></mat-spinner>
              <span>Cargando m√©tricas del usuario...</span>
            </div>
          </mat-card-content>
        </mat-card>
      </div>

      <!-- M√©tricas del usuario -->
      <div class="user-metrics" *ngIf="!isLoadingUserDetail && selectedUserMetrics">
        
        <!-- Header del usuario -->
        <mat-card class="user-header-card">
          <mat-card-content>
            <div class="user-header">
              <div class="user-info">
                <h2>{{selectedUserMetrics.userInfo.displayName}}</h2>
                <p>{{selectedUserMetrics.userInfo.email}}</p>
              </div>
              <button mat-icon-button (click)="hideUserDetail()" matTooltip="Cerrar vista detallada">
                <mat-icon>close</mat-icon>
              </button>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- M√©tricas espec√≠ficas del usuario -->
        <div class="user-metrics-grid">

          <div class="user-metric-card workouts-metric">
            <div class="metric-icon-wrapper">
              <mat-icon>fitness_center</mat-icon>
            </div>
            <div class="metric-content">
              <span class="metric-label">Total Entrenamientos</span>
              <span class="metric-value">{{selectedUserMetrics.totalWorkouts}}</span>
              <span class="metric-subtitle">Sesiones completadas</span>
            </div>
          </div>

          <div class="user-metric-card time-metric">
            <div class="metric-icon-wrapper">
              <mat-icon>schedule</mat-icon>
            </div>
            <div class="metric-content">
              <span class="metric-label">Tiempo Total</span>
              <span class="metric-value">{{formatHours(selectedUserMetrics.totalHours)}}</span>
              <span class="metric-subtitle">Horas de entrenamiento</span>
            </div>
          </div>

          <div class="user-metric-card errors-metric">
            <div class="metric-icon-wrapper">
              <mat-icon>warning</mat-icon>
            </div>
            <div class="metric-content">
              <span class="metric-label">Errores Cr√≠ticos</span>
              <span class="metric-value">{{selectedUserMetrics.criticalErrorsTotal}}</span>
              <span class="metric-subtitle">Detectados en total</span>
            </div>
          </div>

        </div>

        <!-- Gr√°fico del usuario espec√≠fico -->
        <mat-card class="user-chart-card">
          <mat-card-header>
            <mat-card-title>
              <mat-icon>trending_up</mat-icon>
              Progreso Semanal - {{selectedUserMetrics.userInfo.displayName}}
            </mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div class="chart-container">
              <canvas #userDetailChart></canvas>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- üÜï HISTORIAL DE ERRORES SEMANALES -->
        <mat-card class="weekly-history-card" *ngIf="weeklyHistory">
          <mat-card-header>
            <mat-card-title>
              <mat-icon>calendar_today</mat-icon>
              Historial de Errores Semanales
            </mat-card-title>
            <mat-card-subtitle>Reducci√≥n de errores por semana</mat-card-subtitle>
          </mat-card-header>
          <mat-card-content>

            <!-- Semana Actual -->
            <div class="week-summary current-week">
              <div class="week-header">
                <h4>{{weeklyHistory.currentWeek.weekLabel}}</h4>
                <span class="week-date">
                  {{weeklyHistory.currentWeek.startDate | date:'dd/MM'}} -
                  {{weeklyHistory.currentWeek.endDate | date:'dd/MM'}}
                </span>
              </div>
              <div class="week-metrics">
                <div class="week-metric">
                  <mat-icon>trending_down</mat-icon>
                  <div class="metric-info">
                    <span class="metric-label">Errores Reducidos</span>
                    <span class="metric-value-large">{{weeklyHistory.currentWeek.totalErrorsReduced}}</span>
                  </div>
                </div>
                <div class="week-metric">
                  <mat-icon>fitness_center</mat-icon>
                  <div class="metric-info">
                    <span class="metric-label">Ejercicios Mejorados</span>
                    <span class="metric-value-large">{{weeklyHistory.currentWeek.exercisesImproved}}</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Semanas Anteriores -->
            <div class="previous-weeks">
              <div class="week-summary" *ngFor="let week of weeklyHistory.previousWeeks">
                <div class="week-header">
                  <h5>{{week.weekLabel}}</h5>
                  <span class="week-date-small">
                    {{week.startDate | date:'dd/MM'}} - {{week.endDate | date:'dd/MM'}}
                  </span>
                </div>
                <div class="week-metrics-compact">
                  <div class="compact-metric">
                    <mat-icon>trending_down</mat-icon>
                    <span>{{week.totalErrorsReduced}} errores</span>
                  </div>
                  <div class="compact-metric">
                    <mat-icon>check_circle</mat-icon>
                    <span>{{week.exercisesImproved}} mejorados</span>
                  </div>
                </div>
              </div>
            </div>

          </mat-card-content>
        </mat-card>

        <!-- üÜï PROGRESO DETALLADO POR EJERCICIO (S1 vs S2) -->
        <mat-card class="exercise-progress-card" *ngIf="weeklyHistory && weeklyHistory.currentWeek && weeklyHistory.currentWeek.exercises && weeklyHistory.currentWeek.exercises.length > 0">
          <mat-card-header>
            <mat-card-title>
              <mat-icon>timeline</mat-icon>
              Progreso Detallado por Ejercicio
            </mat-card-title>
            <mat-card-subtitle>Comparaci√≥n Sesi√≥n 1 vs Sesi√≥n 2 (Semana Actual)</mat-card-subtitle>
          </mat-card-header>
          <mat-card-content>

            <div class="exercise-progress-list">
              <div class="exercise-item" *ngFor="let exercise of weeklyHistory.currentWeek.exercises">

                <div class="exercise-header">
                  <h4>{{exercise.exerciseName}}</h4>
                  <mat-chip [class]="'status-chip ' + exercise.status">
                    <mat-icon *ngIf="exercise.status === 'improved'">trending_up</mat-icon>
                    <mat-icon *ngIf="exercise.status === 'worsened'">trending_down</mat-icon>
                    <mat-icon *ngIf="exercise.status === 'baseline'">info</mat-icon>
                    {{exercise.status === 'improved' ? 'Mejorado' :
                      exercise.status === 'worsened' ? 'Empeor√≥' :
                      exercise.status === 'baseline' ? 'L√≠nea Base' : 'Pendiente'}}
                  </mat-chip>
                </div>

                <div class="sessions-comparison">

                  <!-- Sesi√≥n 1 -->
                  <div class="session-box session-1" *ngIf="exercise.session1">
                    <div class="session-label">
                      <mat-icon>looks_one</mat-icon>
                      <span>Sesi√≥n 1</span>
                    </div>
                    <div class="error-count">{{exercise.session1.errorsDetected}} errores</div>
                    <div class="session-date">{{exercise.session1.timestamp | date:'dd/MM HH:mm'}}</div>
                  </div>

                  <!-- Flecha de comparaci√≥n -->
                  <div class="comparison-arrow" *ngIf="exercise.session1 && exercise.session2">
                    <mat-icon [class]="exercise.errorReduction! > 0 ? 'arrow-positive' : 'arrow-negative'">
                      {{exercise.errorReduction! > 0 ? 'arrow_forward' : 'arrow_forward'}}
                    </mat-icon>
                  </div>

                  <!-- Sesi√≥n 2 -->
                  <div class="session-box session-2" *ngIf="exercise.session2">
                    <div class="session-label">
                      <mat-icon>looks_two</mat-icon>
                      <span>Sesi√≥n 2</span>
                    </div>
                    <div class="error-count">{{exercise.session2.errorsDetected}} errores</div>
                    <div class="session-date">{{exercise.session2.timestamp | date:'dd/MM HH:mm'}}</div>
                  </div>

                  <!-- Mensaje si solo hay S1 -->
                  <div class="pending-session" *ngIf="exercise.session1 && !exercise.session2">
                    <mat-icon>schedule</mat-icon>
                    <span>Esperando segunda sesi√≥n...</span>
                  </div>

                </div>

                <!-- Reducci√≥n de errores -->
                <div class="error-reduction-summary" *ngIf="exercise.errorReduction !== undefined">
                  <div class="reduction-badge" [class]="exercise.errorReduction > 0 ? 'positive' : 'negative'">
                    <mat-icon>{{exercise.errorReduction > 0 ? 'remove' : 'add'}}</mat-icon>
                    <span>
                      {{exercise.errorReduction > 0 ? '-' : '+'}}{{Math.abs(exercise.errorReduction)}} errores
                    </span>
                  </div>
                  <div class="improvement-percentage" *ngIf="exercise.improvementPercentage">
                    ({{exercise.improvementPercentage > 0 ? '+' : ''}}{{exercise.improvementPercentage}}% cambio)
                  </div>
                </div>

                <!-- Barra de progreso -->
                <div class="progress-bar-wrapper" *ngIf="exercise.session1 && exercise.session2">
                  <div class="progress-bar-comparison">
                    <div class="bar bar-session1"
                         [style.width.%]="(exercise.session1.errorsDetected / Math.max(exercise.session1.errorsDetected, exercise.session2.errorsDetected)) * 100">
                    </div>
                  </div>
                  <div class="progress-bar-comparison">
                    <div class="bar bar-session2"
                         [style.width.%]="(exercise.session2.errorsDetected / Math.max(exercise.session1.errorsDetected, exercise.session2.errorsDetected)) * 100">
                    </div>
                  </div>
                </div>

              </div>
            </div>

            <!-- Mensaje si no hay ejercicios -->
            <div class="empty-state" *ngIf="weeklyHistory && weeklyHistory.currentWeek && weeklyHistory.currentWeek.exercises && weeklyHistory.currentWeek.exercises.length === 0">
              <mat-icon>fitness_center</mat-icon>
              <p>A√∫n no hay ejercicios registrados esta semana</p>
              <p class="empty-subtitle">Los ejercicios aparecer√°n aqu√≠ despu√©s de la primera sesi√≥n</p>
            </div>

          </mat-card-content>
        </mat-card>

      </div>
    </div>

    <!-- ‚úÖ GR√ÅFICOS GLOBALES -->
    <div class="global-charts-section fade-in-up" *ngIf="!showUserDetail">
      
      <!-- Actividad Global -->
      <mat-card class="chart-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>bar_chart</mat-icon>
            Actividad Global del Gimnasio
          </mat-card-title>
          <mat-card-subtitle>Usuarios activos y entrenamientos por d√≠a</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <div class="chart-container">
            <canvas #globalActivityChart></canvas>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Grid de gr√°ficos secundarios -->
      <div class="secondary-charts-grid">

        <!-- Distribuci√≥n de Errores -->
        <mat-card class="chart-card">
          <mat-card-header>
            <mat-card-title>
              <mat-icon>pie_chart</mat-icon>
              Errores M√°s Comunes
            </mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div class="chart-container">
              <canvas #globalErrorsChart></canvas>
            </div>
          </mat-card-content>
        </mat-card>

      </div>

    </div>

    <!-- ‚úÖ USUARIOS M√ÅS ACTIVOS -->
    <mat-card class="top-users-card fade-in-up" *ngIf="!showUserDetail && globalMetrics?.topActiveUsers && globalMetrics.topActiveUsers.length > 0">

      <mat-card-header>
        <mat-card-title>
          <mat-icon>emoji_events</mat-icon>
          Usuarios M√°s Activos
        </mat-card-title>
        <mat-card-subtitle>Top 5 usuarios con m√°s entrenamientos</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="top-users-list">
          <div class="user-rank-item"
               *ngFor="let user of globalMetrics.topActiveUsers; let i = index"
               (click)="onUserSelected(user.uid)">
            <div class="rank-badge" [class]="'rank-' + (i + 1)">
              <mat-icon *ngIf="i === 0">emoji_events</mat-icon>
              <mat-icon *ngIf="i === 1">emoji_events</mat-icon>
              <mat-icon *ngIf="i === 2">emoji_events</mat-icon>
              <span *ngIf="i > 2">{{i + 1}}</span>
            </div>
            <div class="user-rank-info">
              <div class="user-rank-header">
                <span class="user-rank-name">{{user.displayName}}</span>
                <span class="user-rank-position">#{{i + 1}}</span>
              </div>
              <div class="user-rank-stats">
                <mat-icon>fitness_center</mat-icon>
                <span>{{user.workouts}} entrenamientos completados</span>
              </div>
            </div>
            <button mat-icon-button class="view-btn">
              <mat-icon>chevron_right</mat-icon>
            </button>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- ‚úÖ ALERTAS RECIENTES -->
    <mat-card class="recent-alerts-card fade-in-up" *ngIf="!showUserDetail && globalMetrics?.recentAlertsGlobal && globalMetrics.recentAlertsGlobal.length > 0">

      <mat-card-header>
        <mat-card-title>
          <mat-icon [matBadge]="globalMetrics.recentAlertsGlobal.length" matBadgeColor="warn">
            notification_important
          </mat-icon>
          Alertas Recientes
        </mat-card-title>
        <mat-card-subtitle>Errores cr√≠ticos detectados en la √∫ltima semana</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="alerts-list-modern">
          <div class="alert-item-modern" *ngFor="let alert of globalMetrics.recentAlertsGlobal.slice(0, 5)">
            <div class="alert-icon-wrapper" [class]="'severity-' + alert.severity">
              <mat-icon>warning</mat-icon>
            </div>
            <div class="alert-content">
              <div class="alert-header">
                <span class="alert-user-name">{{alert.userDisplayName || 'Usuario desconocido'}}</span>
                <span class="alert-timestamp">{{alert.processedAt | date:'dd/MM HH:mm'}}</span>
              </div>
              <div class="alert-details">
                <span class="alert-error-type">{{getErrorTypeLabel(alert.errorType)}}</span>
                <span class="alert-separator">‚Ä¢</span>
                <span class="alert-exercise-name">{{alert.exercise}}</span>
              </div>
            </div>
            <mat-icon class="alert-chevron">chevron_right</mat-icon>
          </div>
        </div>
        <div class="alerts-actions">
          <button mat-raised-button
                  color="warn"
                  (click)="navigateToAlerts()"
                  class="view-all-alerts-btn">
            <mat-icon>visibility</mat-icon>
            Ver Todas las Alertas
          </button>
        </div>
      </mat-card-content>
    </mat-card>

  </div>

  <!-- ‚úÖ ESTADO VAC√çO -->
  <div class="empty-state fade-in-up" *ngIf="!isLoading && globalMetrics?.isEmpty">
    <mat-card class="empty-card">
      <mat-card-content>
        <div class="empty-content">
          <mat-icon class="empty-icon">people_outline</mat-icon>
          <h3>No hay usuarios registrados</h3>
          <p>A√∫n no se han registrado usuarios en la aplicaci√≥n m√≥vil.</p>
          <p>Los datos aparecer√°n aqu√≠ cuando los usuarios comiencen a entrenar.</p>
          <button mat-raised-button 
                  color="primary" 
                  (click)="navigateToUserManagement()">
            <mat-icon>add</mat-icon>
            Gestionar Usuarios
          </button>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

</div>