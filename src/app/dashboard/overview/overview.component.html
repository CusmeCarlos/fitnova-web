<!-- src/app/dashboard/overview/overview.component.html -->
<!-- üìä DASHBOARD PREMIUM - SIN HEADER REDUNDANTE -->

<div class="dashboard-container">

  <!-- ‚úÖ LOADING STATE -->
  <div class="loading-container" *ngIf="isLoading">
    <div class="loading-content">
      <mat-spinner diameter="50"></mat-spinner>
      <p>Cargando m√©tricas del gimnasio...</p>
    </div>
  </div>

  <!-- ‚úÖ CONTENIDO PRINCIPAL -->
  <div class="dashboard-content" *ngIf="!isLoading && globalMetrics">

    <!-- ‚úÖ M√âTRICAS PRINCIPALES -->
    <div class="metrics-section">
      <h3 class="fade-in-up">
        <mat-icon>dashboard</mat-icon>
        Resumen de Entrenamiento
      </h3>
      
      <div class="metrics-grid">
        
        <!-- Total Usuarios -->
        <div class="metric-card users-card fade-in-up stagger-1">
          <div class="metric-header">
            <div class="metric-info">
              <div class="metric-title">Total Usuarios</div>
              <div class="metric-subtitle">Registrados en la plataforma</div>
            </div>
            <div class="metric-icon">
              <mat-icon>people</mat-icon>
            </div>
          </div>
          <div class="metric-value">{{formatNumber(globalMetrics.totalUsers)}}</div>
          <div class="metric-change positive">
            <mat-icon class="change-icon">trending_up</mat-icon>
            <span>{{globalMetrics.activeUsersToday}} activos hoy</span>
          </div>
        </div>

        <!-- Entrenamientos Hoy -->
        <div class="metric-card training-card fade-in-up stagger-2">
          <div class="metric-header">
            <div class="metric-info">
              <div class="metric-title">Entrenamientos Hoy</div>
              <div class="metric-subtitle">Sesiones completadas</div>
            </div>
            <div class="metric-icon">
              <mat-icon>fitness_center</mat-icon>
            </div>
          </div>
          <div class="metric-value">{{formatNumber(globalMetrics.totalWorkoutsToday)}}</div>
          <div class="metric-change positive">
            <mat-icon class="change-icon">arrow_upward</mat-icon>
            <span>{{formatNumber(globalMetrics.totalWorkoutsAllTime)}} totales</span>
          </div>
        </div>

        <!-- Precisi√≥n Promedio -->
        <div class="metric-card accuracy-card fade-in-up stagger-3">
          <div class="metric-header">
            <div class="metric-info">
              <div class="metric-title">Precisi√≥n Promedio</div>
              <div class="metric-subtitle">Todos los usuarios</div>
            </div>
            <div class="metric-icon">
              <mat-icon>target</mat-icon>
            </div>
          </div>
          <div class="metric-value">{{formatPercentage(globalMetrics.averageAccuracyGlobal)}}</div>

          <div class="metric-change positive">
            <mat-icon class="change-icon">trending_up</mat-icon>
            <span>Mejorando</span>
          </div>
        </div>

        <!-- Errores Cr√≠ticos -->
        <div class="metric-card errors-card fade-in-up stagger-4">
          <div class="metric-header">
            <div class="metric-info">
              <div class="metric-title">Errores Cr√≠ticos</div>
              <div class="metric-subtitle">Detectados hoy</div>
            </div>
            <div class="metric-icon">
              <mat-icon>warning</mat-icon>
            </div>
          </div>
          <div class="metric-value">{{formatNumber(globalMetrics.criticalErrorsToday)}}</div>
          <div class="metric-change" [class]="globalMetrics.criticalErrorsToday === 0 ? 'positive' : 'negative'">
            <mat-icon class="change-icon">
              {{globalMetrics.criticalErrorsToday === 0 ? 'check_circle' : 'warning'}}
            </mat-icon>
            <span>{{globalMetrics.criticalErrorsToday === 0 ? 'Sin errores' : 'Requiere atenci√≥n'}}</span>
          </div>
        </div>

      </div>
    </div>

    <!-- ‚úÖ ACCIONES R√ÅPIDAS -->
    <div class="quick-actions-section fade-in-up">
      <h3>
        <mat-icon>bolt</mat-icon>
        Acciones R√°pidas
      </h3>
      
      <div class="actions-grid">
        <a class="action-card" (click)="navigateToUserManagement()">
          <div class="action-icon">
            <mat-icon>people</mat-icon>
          </div>
          <span class="action-text">Gestionar Usuarios</span>
        </a>

        <a class="action-card" (click)="navigateToRoutines()">
          <div class="action-icon">
            <mat-icon>assignment</mat-icon>
          </div>
          <span class="action-text">Validar Rutinas IA</span>
        </a>

        <a class="action-card" (click)="navigateToAlerts()">
          <div class="action-icon">
            <mat-icon>notification_important</mat-icon>
          </div>
          <span class="action-text">Centro de Alertas</span>
        </a>

        <a class="action-card" (click)="navigateToAnalytics()">
          <div class="action-icon">
            <mat-icon>analytics</mat-icon>
          </div>
          <span class="action-text">Analytics Avanzado</span>
        </a>
      </div>
    </div>

    <!-- ‚úÖ SECCI√ìN DE PROGRESO -->
    <div class="progress-section fade-in-up" *ngIf="!showUserDetail">
      <div class="progress-header">
        <h3>
          <mat-icon>trending_up</mat-icon>
          Progreso de Usuarios
        </h3>
        <a href="#" class="view-all-btn" (click)="navigateToAnalytics()">Ver todo</a>
      </div>
      
      <div class="progress-list">
        <div class="progress-item" *ngFor="let user of allUsers.slice(0, 3)">
          <div class="progress-info">
            <div class="progress-name">{{user.displayName}}</div>
            <div class="progress-detail">{{user.totalWorkouts || 0}} entrenamientos completados</div>
          </div>
          <div class="progress-bar-container">
            <div class="progress-bar" [style.width.%]="user.averageAccuracy || 0"></div>
          </div>
          <div class="progress-percentage">{{user.averageAccuracy || 0}}%</div>
        </div>
      </div>
    </div>

    <!-- ‚úÖ SELECTOR DE USUARIO -->
    <mat-card class="user-selector-card fade-in-up" *ngIf="!showUserDetail">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>person_search</mat-icon>
          Vista Detallada por Usuario
        </mat-card-title>
        <mat-card-subtitle>Selecciona un usuario para ver sus m√©tricas espec√≠ficas</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <mat-form-field appearance="outline" class="user-select">
          <mat-label>Seleccionar Usuario</mat-label>
          <mat-select [value]="selectedUserId" 
                      (selectionChange)="onUserSelected($event.value)"
                      placeholder="Elige un usuario...">
            <mat-option value="">-- Ver m√©tricas globales --</mat-option>
            <mat-option *ngFor="let user of allUsers" [value]="user.uid">
              <div class="user-option">
                <span class="user-name">{{user.displayName}}</span>
                <span class="user-stats">
                  {{user.totalWorkouts || 0}} entrenamientos ¬∑ 
                  {{user.averageAccuracy || 0}}% precisi√≥n
                </span>
                <mat-chip [color]="getUserStatusColor(user)" class="status-chip">
                  {{getUserStatusColor(user) === 'primary' ? 'Activo hoy' : 
                    getUserStatusColor(user) === 'accent' ? 'Reciente' : 'Inactivo'}}
                </mat-chip>
              </div>
            </mat-option>
          </mat-select>
        </mat-form-field>
      </mat-card-content>
    </mat-card>

    <!-- ‚úÖ VISTA DETALLADA DEL USUARIO -->
    <div class="user-detail-section fade-in-up" *ngIf="showUserDetail">
      
      <!-- Loading del usuario -->
      <div class="user-loading" *ngIf="isLoadingUserDetail">
        <mat-card>
          <mat-card-content>
            <div class="loading-content">
              <mat-spinner diameter="30"></mat-spinner>
              <span>Cargando m√©tricas del usuario...</span>
            </div>
          </mat-card-content>
        </mat-card>
      </div>

      <!-- M√©tricas del usuario -->
      <div class="user-metrics" *ngIf="!isLoadingUserDetail && selectedUserMetrics">
        
        <!-- Header del usuario -->
        <mat-card class="user-header-card">
          <mat-card-content>
            <div class="user-header">
              <div class="user-info">
                <h2>{{selectedUserMetrics.userInfo.displayName}}</h2>
                <p>{{selectedUserMetrics.userInfo.email}}</p>
              </div>
              <button mat-icon-button (click)="hideUserDetail()" matTooltip="Cerrar vista detallada">
                <mat-icon>close</mat-icon>
              </button>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- M√©tricas espec√≠ficas del usuario -->
        <div class="user-metrics-grid">
          
          <mat-card class="user-metric-card">
            <mat-card-content>
              <div class="metric-header">
                <mat-icon>fitness_center</mat-icon>
                <span class="metric-label">Entrenamientos</span>
              </div>
              <div class="metric-value">{{selectedUserMetrics.totalWorkouts}}</div>
            </mat-card-content>
          </mat-card>

          <mat-card class="user-metric-card">
            <mat-card-content>
              <div class="metric-header">
                <mat-icon>track_changes</mat-icon>
                <span class="metric-label">Precisi√≥n</span>
              </div>
              <div class="metric-value">{{formatPercentage(selectedUserMetrics.accuracy)}}</div>

            </mat-card-content>
          </mat-card>

          <mat-card class="user-metric-card">
            <mat-card-content>
              <div class="metric-header">
                <mat-icon>schedule</mat-icon>
                <span class="metric-label">Tiempo Total</span>
              </div>
              <div class="metric-value">{{formatHours(selectedUserMetrics.totalHours)}}</div>
            </mat-card-content>
          </mat-card>

          <mat-card class="user-metric-card">
            <mat-card-content>
              <div class="metric-header">
                <mat-icon>warning</mat-icon>
                <span class="metric-label">Errores Cr√≠ticos</span>
              </div>
              <div class="metric-value">{{selectedUserMetrics.criticalErrorsTotal}}</div>
            </mat-card-content>
          </mat-card>

        </div>

        <!-- Gr√°fico del usuario espec√≠fico -->
        <mat-card class="user-chart-card">
          <mat-card-header>
            <mat-card-title>
              <mat-icon>trending_up</mat-icon>
              Progreso Semanal - {{selectedUserMetrics.userInfo.displayName}}
            </mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div class="chart-container">
              <canvas #userDetailChart></canvas>
            </div>
          </mat-card-content>
        </mat-card>

      </div>
    </div>

    <!-- ‚úÖ GR√ÅFICOS GLOBALES -->
    <div class="global-charts-section fade-in-up" *ngIf="!showUserDetail">
      
      <!-- Actividad Global -->
      <mat-card class="chart-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>bar_chart</mat-icon>
            Actividad Global del Gimnasio
          </mat-card-title>
          <mat-card-subtitle>Usuarios activos y entrenamientos por d√≠a</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <div class="chart-container">
            <canvas #globalActivityChart></canvas>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Grid de gr√°ficos secundarios -->
      <div class="secondary-charts-grid">
        
        <!-- Tendencia de Precisi√≥n Global -->
        <mat-card class="chart-card">
          <mat-card-header>
            <mat-card-title>
              <mat-icon>show_chart</mat-icon>
              Tendencia de Precisi√≥n
            </mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div class="chart-container">
              <canvas #globalAccuracyChart></canvas>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Distribuci√≥n de Errores -->
        <mat-card class="chart-card">
          <mat-card-header>
            <mat-card-title>
              <mat-icon>pie_chart</mat-icon>
              Errores M√°s Comunes
            </mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div class="chart-container">
              <canvas #globalErrorsChart></canvas>
            </div>
          </mat-card-content>
        </mat-card>

      </div>

    </div>

    <!-- ‚úÖ USUARIOS M√ÅS ACTIVOS -->
    <mat-card class="top-users-card fade-in-up" *ngIf="!showUserDetail && globalMetrics?.topActiveUsers && globalMetrics.topActiveUsers.length > 0">

      <mat-card-header>
        <mat-card-title>
          <mat-icon>emoji_events</mat-icon>
          Usuarios M√°s Activos
        </mat-card-title>
        <mat-card-subtitle>Top 5 usuarios con m√°s entrenamientos</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="top-users-list">
          <div class="user-rank-item" 
               *ngFor="let user of globalMetrics.topActiveUsers; let i = index"
               (click)="onUserSelected(user.uid)">
            <div class="rank-badge">
              <mat-icon *ngIf="i === 0" class="gold">emoji_events</mat-icon>
              <mat-icon *ngIf="i === 1" class="silver">emoji_events</mat-icon>
              <mat-icon *ngIf="i === 2" class="bronze">emoji_events</mat-icon>
              <span *ngIf="i > 2" class="rank-number">{{i + 1}}</span>
            </div>
            <div class="user-rank-info">
              <span class="user-rank-name">{{user.displayName}}</span>
              <span class="user-rank-stats">
                {{user.workouts}} entrenamientos ¬∑ {{user.accuracy}}% precisi√≥n
              </span>
            </div>
            <mat-icon class="view-icon">chevron_right</mat-icon>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- ‚úÖ ALERTAS RECIENTES -->
    <mat-card class="recent-alerts-card fade-in-up" *ngIf="!showUserDetail && globalMetrics?.recentAlertsGlobal && globalMetrics.recentAlertsGlobal.length > 0">

      <mat-card-header>
        <mat-card-title>
          <mat-icon [matBadge]="globalMetrics.recentAlertsGlobal.length" matBadgeColor="warn">
            notification_important
          </mat-icon>
          Alertas Recientes
        </mat-card-title>
        <mat-card-subtitle>Errores cr√≠ticos de la √∫ltima semana</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="alerts-list">
          <div class="alert-item" *ngFor="let alert of globalMetrics.recentAlertsGlobal.slice(0, 5)">
            <div class="alert-severity" [class]="'severity-' + alert.severity">
              <mat-icon>warning</mat-icon>
            </div>
            <div class="alert-info">
              <span class="alert-user">{{alert.userDisplayName || 'Usuario desconocido'}}</span>
              <span class="alert-error">{{getErrorTypeLabel(alert.errorType)}}</span>
              <span class="alert-exercise">{{alert.exercise}}</span>
            </div>
            <div class="alert-time">
              {{alert.processedAt | date:'dd/MM HH:mm'}}
            </div>
          </div>
        </div>
        <div class="alerts-actions">
          <button mat-raised-button 
                  color="warn" 
                  (click)="navigateToAlerts()"
                  class="view-all-alerts-btn">
            <mat-icon>visibility</mat-icon>
            Ver Todas las Alertas
          </button>
        </div>
      </mat-card-content>
    </mat-card>

  </div>

  <!-- ‚úÖ ESTADO VAC√çO -->
  <div class="empty-state fade-in-up" *ngIf="!isLoading && globalMetrics?.isEmpty">
    <mat-card class="empty-card">
      <mat-card-content>
        <div class="empty-content">
          <mat-icon class="empty-icon">people_outline</mat-icon>
          <h3>No hay usuarios registrados</h3>
          <p>A√∫n no se han registrado usuarios en la aplicaci√≥n m√≥vil.</p>
          <p>Los datos aparecer√°n aqu√≠ cuando los usuarios comiencen a entrenar.</p>
          <button mat-raised-button 
                  color="primary" 
                  (click)="navigateToUserManagement()">
            <mat-icon>add</mat-icon>
            Gestionar Usuarios
          </button>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

</div>