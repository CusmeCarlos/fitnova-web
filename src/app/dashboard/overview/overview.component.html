<!-- src/app/dashboard/overview/overview.component.html -->
<!-- üìä DASHBOARD GLOBAL - SUPERVISI√ìN DE TODOS LOS USUARIOS -->

<div class="dashboard-container">
  
    <!-- ‚úÖ HEADER GLOBAL -->
    <div class="dashboard-header">
      <div class="welcome-section">
        <h1 class="dashboard-title">
          <mat-icon>supervisor_account</mat-icon>
          Dashboard de Supervisi√≥n
        </h1>
        <p class="welcome-message" *ngIf="currentUser">
          <strong>{{currentUser.displayName}}</strong> 
          <mat-chip [color]="currentUser.role === 'admin' ? 'primary' : 'accent'">
            {{currentUser.role === 'admin' ? 'Administrador' : 'Entrenador'}}
          </mat-chip>
        </p>
        <p class="last-updated">
          √öltima actualizaci√≥n: {{lastUpdated | date:'dd/MM/yyyy HH:mm'}}
        </p>
      </div>
      
      <!-- ‚úÖ ACCIONES DEL HEADER -->
      <div class="header-actions">
        <button mat-icon-button 
                (click)="refreshDashboard()" 
                [disabled]="isLoading"
                matTooltip="Actualizar dashboard">
          <mat-icon [class.spinning]="isLoading">refresh</mat-icon>
        </button>
        
        <!-- ‚úÖ BOT√ìN LOGOUT -->
        <button mat-icon-button 
                (click)="logout()" 
                matTooltip="Cerrar sesi√≥n"
                class="logout-btn">
          <mat-icon>logout</mat-icon>
        </button>
      </div>
    </div>
  
    <!-- ‚úÖ LOADING STATE GLOBAL -->
    <div class="loading-container" *ngIf="isLoading">
      <div class="loading-content">
        <mat-spinner diameter="50"></mat-spinner>
        <p>Cargando m√©tricas globales del gimnasio...</p>
      </div>
    </div>
  
    <!-- ‚úÖ CONTENIDO PRINCIPAL -->
    <div class="dashboard-content" *ngIf="!isLoading && globalMetrics">
  
      <!-- ‚úÖ M√âTRICAS GLOBALES PRINCIPALES -->
      <div class="global-metrics-grid">
        
        <!-- üë• TOTAL USUARIOS -->
        <mat-card class="metric-card users-card">
          <mat-card-content>
            <div class="metric-header">
              <mat-icon>people</mat-icon>
              <span class="metric-label">Total Usuarios</span>
            </div>
            <div class="metric-value">
              {{formatNumber(globalMetrics.totalUsers)}}
            </div>
            <div class="metric-subtitle">
              <span class="active-today">{{globalMetrics.activeUsersToday}} activos hoy</span>
            </div>
          </mat-card-content>
        </mat-card>
  
        <!-- üèãÔ∏è ENTRENAMIENTOS HOY -->
        <mat-card class="metric-card workouts-card">
          <mat-card-content>
            <div class="metric-header">
              <mat-icon>fitness_center</mat-icon>
              <span class="metric-label">Entrenamientos Hoy</span>
            </div>
            <div class="metric-value">
              {{formatNumber(globalMetrics.totalWorkoutsToday)}}
            </div>
            <div class="metric-subtitle">
              {{formatNumber(globalMetrics.totalWorkoutsAllTime)}} totales
            </div>
          </mat-card-content>
        </mat-card>
  
        <!-- üìä PRECISI√ìN GLOBAL -->
        <mat-card class="metric-card accuracy-card">
          <mat-card-content>
            <div class="metric-header">
              <mat-icon>track_changes</mat-icon>
              <span class="metric-label">Precisi√≥n Promedio</span>
            </div>
            <div class="metric-value">
              {{globalMetrics.averageAccuracyGlobal}}%
            </div>
            <div class="metric-subtitle">Todos los usuarios</div>
          </mat-card-content>
        </mat-card>
  
        <!-- üö® ERRORES CR√çTICOS HOY -->
        <mat-card class="metric-card alerts-card">
          <mat-card-content>
            <div class="metric-header">
              <mat-icon [matBadge]="globalMetrics.criticalErrorsToday" 
                       [matBadgeHidden]="globalMetrics.criticalErrorsToday === 0"
                       matBadgeColor="warn">
                warning
              </mat-icon>
              <span class="metric-label">Errores Cr√≠ticos</span>
            </div>
            <div class="metric-value">
              {{formatNumber(globalMetrics.criticalErrorsToday)}}
            </div>
            <div class="metric-subtitle">Detectados hoy</div>
          </mat-card-content>
        </mat-card>
  
      </div>
  
      <!-- ‚úÖ SELECTOR DE USUARIO PARA VISTA DETALLADA -->
      <mat-card class="user-selector-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>person_search</mat-icon>
            Vista Detallada por Usuario
          </mat-card-title>
          <mat-card-subtitle>Selecciona un usuario para ver sus m√©tricas espec√≠ficas</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <mat-form-field appearance="outline" class="user-select">
            <mat-label>Seleccionar Usuario</mat-label>
            <mat-select [value]="selectedUserId" 
                        (selectionChange)="onUserSelected($event.value)"
                        placeholder="Elige un usuario...">
              <mat-option value="">-- Ver m√©tricas globales --</mat-option>
              <mat-option *ngFor="let user of allUsers" [value]="user.uid">
                <div class="user-option">
                  <span class="user-name">{{user.displayName}}</span>
                  <span class="user-stats">
                    {{user.totalWorkouts || 0}} entrenamientos ¬∑ 
                    {{user.averageAccuracy || 0}}% precisi√≥n
                  </span>
                  <mat-chip [color]="getUserStatusColor(user)" class="status-chip">
                    {{getUserStatusColor(user) === 'primary' ? 'Activo hoy' : 
                      getUserStatusColor(user) === 'accent' ? 'Reciente' : 'Inactivo'}}
                  </mat-chip>
                </div>
              </mat-option>
            </mat-select>
          </mat-form-field>
        </mat-card-content>
      </mat-card>
  
      <!-- ‚úÖ VISTA DETALLADA DEL USUARIO SELECCIONADO -->
      <div class="user-detail-section" *ngIf="showUserDetail">
        
        <!-- Loading del usuario -->
        <div class="user-loading" *ngIf="isLoadingUserDetail">
          <mat-card>
            <mat-card-content>
              <div class="loading-content">
                <mat-spinner diameter="30"></mat-spinner>
                <span>Cargando m√©tricas del usuario...</span>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
  
        <!-- M√©tricas del usuario -->
        <div class="user-metrics" *ngIf="!isLoadingUserDetail && selectedUserMetrics">
          
          <!-- Header del usuario -->
          <mat-card class="user-header-card">
            <mat-card-content>
              <div class="user-header">
                <div class="user-info">
                  <h2>{{selectedUserMetrics.userInfo.displayName}}</h2>
                  <p>{{selectedUserMetrics.userInfo.email}}</p>
                </div>
                <button mat-icon-button (click)="hideUserDetail()" matTooltip="Cerrar vista detallada">
                  <mat-icon>close</mat-icon>
                </button>
              </div>
            </mat-card-content>
          </mat-card>
  
          <!-- M√©tricas espec√≠ficas del usuario -->
          <div class="user-metrics-grid">
            
            <mat-card class="user-metric-card">
              <mat-card-content>
                <div class="metric-header">
                  <mat-icon>fitness_center</mat-icon>
                  <span class="metric-label">Entrenamientos</span>
                </div>
                <div class="metric-value">{{selectedUserMetrics.totalWorkouts}}</div>
              </mat-card-content>
            </mat-card>
  
            <mat-card class="user-metric-card">
              <mat-card-content>
                <div class="metric-header">
                  <mat-icon>track_changes</mat-icon>
                  <span class="metric-label">Precisi√≥n</span>
                </div>
                <div class="metric-value">{{selectedUserMetrics.accuracy}}%</div>
              </mat-card-content>
            </mat-card>
  
            <mat-card class="user-metric-card">
              <mat-card-content>
                <div class="metric-header">
                  <mat-icon>schedule</mat-icon>
                  <span class="metric-label">Tiempo Total</span>
                </div>
                <div class="metric-value">{{formatHours(selectedUserMetrics.totalHours)}}</div>
              </mat-card-content>
            </mat-card>
  
            <mat-card class="user-metric-card">
              <mat-card-content>
                <div class="metric-header">
                  <mat-icon>warning</mat-icon>
                  <span class="metric-label">Errores Cr√≠ticos</span>
                </div>
                <div class="metric-value">{{selectedUserMetrics.criticalErrorsTotal}}</div>
              </mat-card-content>
            </mat-card>
  
          </div>
  
          <!-- Gr√°fico del usuario espec√≠fico -->
          <mat-card class="user-chart-card">
            <mat-card-header>
              <mat-card-title>
                <mat-icon>trending_up</mat-icon>
                Progreso Semanal - {{selectedUserMetrics.userInfo.displayName}}
              </mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="chart-container">
                <canvas #userDetailChart></canvas>
              </div>
            </mat-card-content>
          </mat-card>
  
        </div>
      </div>
  
      <!-- ‚úÖ GR√ÅFICOS GLOBALES (solo si no hay usuario seleccionado) -->
      <div class="global-charts-section" *ngIf="!showUserDetail">
        
        <!-- Actividad Global -->
        <mat-card class="chart-card">
          <mat-card-header>
            <mat-card-title>
              <mat-icon>bar_chart</mat-icon>
              Actividad Global del Gimnasio
            </mat-card-title>
            <mat-card-subtitle>Usuarios activos y entrenamientos por d√≠a</mat-card-subtitle>
          </mat-card-header>
          <mat-card-content>
            <div class="chart-container">
              <canvas #globalActivityChart></canvas>
            </div>
          </mat-card-content>
        </mat-card>
  
        <!-- Grid de gr√°ficos secundarios -->
        <div class="secondary-charts-grid">
          
          <!-- Tendencia de Precisi√≥n Global -->
          <mat-card class="chart-card">
            <mat-card-header>
              <mat-card-title>
                <mat-icon>show_chart</mat-icon>
                Tendencia de Precisi√≥n
              </mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="chart-container">
                <canvas #globalAccuracyChart></canvas>
              </div>
            </mat-card-content>
          </mat-card>
  
          <!-- Distribuci√≥n de Errores -->
          <mat-card class="chart-card">
            <mat-card-header>
              <mat-card-title>
                <mat-icon>pie_chart</mat-icon>
                Errores M√°s Comunes
              </mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="chart-container">
                <canvas #globalErrorsChart></canvas>
              </div>
            </mat-card-content>
          </mat-card>
  
        </div>
  
      </div>
  
      <!-- ‚úÖ USUARIOS M√ÅS ACTIVOS -->
      <mat-card class="top-users-card" *ngIf="!showUserDetail">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>emoji_events</mat-icon>
            Usuarios M√°s Activos
          </mat-card-title>
          <mat-card-subtitle>Top 5 usuarios con m√°s entrenamientos</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <div class="top-users-list">
            <div class="user-rank-item" 
                 *ngFor="let user of globalMetrics.topActiveUsers; let i = index"
                 (click)="onUserSelected(user.uid)">
              <div class="rank-badge">
                <mat-icon *ngIf="i === 0" class="gold">emoji_events</mat-icon>
                <mat-icon *ngIf="i === 1" class="silver">emoji_events</mat-icon>
                <mat-icon *ngIf="i === 2" class="bronze">emoji_events</mat-icon>
                <span *ngIf="i > 2" class="rank-number">{{i + 1}}</span>
              </div>
              <div class="user-rank-info">
                <span class="user-rank-name">{{user.displayName}}</span>
                <span class="user-rank-stats">
                  {{user.workouts}} entrenamientos ¬∑ {{user.accuracy}}% precisi√≥n
                </span>
              </div>
              <mat-icon class="view-icon">chevron_right</mat-icon>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
  
      <!-- ‚úÖ ALERTAS RECIENTES GLOBALES -->
      <mat-card class="recent-alerts-card" *ngIf="!showUserDetail && globalMetrics.recentAlertsGlobal.length > 0">
        <mat-card-header>
          <mat-card-title>
            <mat-icon [matBadge]="globalMetrics.recentAlertsGlobal.length" matBadgeColor="warn">
              notification_important
            </mat-icon>
            Alertas Recientes
          </mat-card-title>
          <mat-card-subtitle>Errores cr√≠ticos de la √∫ltima semana</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <div class="alerts-list">
            <div class="alert-item" *ngFor="let alert of globalMetrics.recentAlertsGlobal.slice(0, 5)">
              <div class="alert-severity" [class]="'severity-' + alert.severity">
                <mat-icon>warning</mat-icon>
              </div>
              <div class="alert-info">
                <span class="alert-user">{{alert.userDisplayName || 'Usuario desconocido'}}</span>
                <span class="alert-error">{{getErrorTypeLabel(alert.errorType)}}</span>
                <span class="alert-exercise">{{alert.exercise}}</span>
              </div>
              <div class="alert-time">
                {{alert.processedAt | date:'dd/MM HH:mm'}}
              </div>
            </div>
          </div>
          <div class="alerts-actions">
            <button mat-raised-button 
                    color="warn" 
                    (click)="navigateToAlerts()"
                    class="view-all-alerts-btn">
              <mat-icon>visibility</mat-icon>
              Ver Todas las Alertas
            </button>
          </div>
        </mat-card-content>
      </mat-card>
  
      <!-- ‚úÖ ACCIONES R√ÅPIDAS -->
      <div class="quick-actions" *ngIf="!showUserDetail">
        <h3>Acciones de Supervisi√≥n</h3>
        <div class="actions-grid">
          
          <button mat-raised-button 
                  color="primary" 
                  (click)="navigateToUserManagement()"
                  class="action-btn">
            <mat-icon>people</mat-icon>
            Gestionar Usuarios
          </button>
  
          <button mat-raised-button 
                  color="accent" 
                  (click)="navigateToRoutines()"
                  class="action-btn">
            <mat-icon>assignment</mat-icon>
            Validar Rutinas IA
          </button>
  
          <button mat-raised-button 
                  color="warn" 
                  (click)="navigateToAlerts()"
                  class="action-btn">
            <mat-icon>notification_important</mat-icon>
            Centro de Alertas
          </button>
  
          <button mat-raised-button 
                  (click)="navigateToAnalytics()"
                  class="action-btn analytics-btn">
            <mat-icon>analytics</mat-icon>
            Analytics Avanzado
          </button>
  
        </div>
      </div>
  
    </div>
  
    <!-- ‚úÖ ESTADO VAC√çO -->
    <div class="empty-state" *ngIf="!isLoading && globalMetrics?.isEmpty">
      <mat-card class="empty-card">
        <mat-card-content>
          <div class="empty-content">
            <mat-icon class="empty-icon">people_outline</mat-icon>
            <h3>No hay usuarios registrados</h3>
            <p>A√∫n no se han registrado usuarios en la aplicaci√≥n m√≥vil.</p>
            <p>Los datos aparecer√°n aqu√≠ cuando los usuarios comiencen a entrenar.</p>
            <button mat-raised-button 
                    color="primary" 
                    (click)="navigateToUserManagement()">
              <mat-icon>add</mat-icon>
              Gestionar Usuarios
            </button>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  
  </div>