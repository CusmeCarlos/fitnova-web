<!-- src/app/shared/settings/settings.component.html -->
<!-- ⚙️ CONFIGURACIÓN DEL SISTEMA - SOLUCIÓN DEFINITIVA -->

<div class="settings-dashboard-container">
  
  <!-- HEADER -->
  <div class="premium-header">
    <div class="header-content">
      <div class="header-left">
        <button mat-icon-button class="back-btn-premium" (click)="goBack()">
          <mat-icon>arrow_back</mat-icon>
        </button>
        
        <div class="header-info">
          <h1 class="premium-title">
            <mat-icon class="title-icon">settings</mat-icon>
            Configuración del Sistema
          </h1>
          <p class="premium-subtitle">Panel de administración y configuración avanzada de FitNova</p>
        </div>
      </div>
      
      <div class="header-actions">
        <button mat-stroked-button class="action-btn-premium" (click)="refreshSettings()">
          <mat-icon>refresh</mat-icon>
          <span>Actualizar</span>
        </button>
        
        <button mat-stroked-button class="action-btn-premium" (click)="exportSettings()">
          <mat-icon>file_download</mat-icon>
          <span>Exportar</span>
        </button>
        
        <button mat-stroked-button class="action-btn-premium danger" (click)="resetToDefaults()" *ngIf="isAdmin()">
          <mat-icon>restore</mat-icon>
          <span>Restaurar</span>
        </button>
      </div>
    </div>
  </div>

  <!-- LOADING -->
  <div class="loading-state-premium" *ngIf="isLoading">
    <div class="loading-content">
      <div class="loading-spinner">
        <mat-spinner diameter="60"></mat-spinner>
      </div>
      <h3>Cargando configuración del sistema...</h3>
      <p>Sincronizando parámetros desde Firebase</p>
    </div>
  </div>

  <!-- CONTENIDO PRINCIPAL -->
  <div class="settings-content-premium" *ngIf="!isLoading && systemSettings">
    
    <mat-tab-group class="premium-tabs" [(selectedIndex)]="selectedTabIndex" animationDuration="300ms">
      
      <!-- TAB 1: IA -->
      <mat-tab>
        <ng-template mat-tab-label>
          <mat-icon>psychology</mat-icon>
          <span>Inteligencia Artificial</span>
        </ng-template>
        
        <div class="tab-content">
          <form [formGroup]="aiForm" class="settings-form">
            
            <div class="section-header">
              <h3>
                <mat-icon>smart_toy</mat-icon>
                Configuración de Parámetros IA
              </h3>
              <p>Ajusta la sensibilidad y precisión de MediaPipe y GPT-4</p>
            </div>

            <!-- MediaPipe Configuration -->
            <mat-card class="config-card">
              <mat-card-header>
                <mat-card-title>
                  <mat-icon>visibility</mat-icon>
                  MediaPipe Pose Detection
                </mat-card-title>
              </mat-card-header>
              <mat-card-content>
                
                <div class="form-row">
                  <div class="form-field">
                    <label class="slider-label">Sensibilidad de Pose</label>
                    <mat-slider 
                      min="0.1" 
                      max="1.0" 
                      step="0.1" 
                      discrete
                      [displayWith]="formatSliderLabel">
                      <input matSliderThumb formControlName="poseSensitivity">
                    </mat-slider>
                    <mat-hint>Valor: {{ formatPercentage(aiForm.get('poseSensitivity')?.value) }}</mat-hint>
                  </div>

                  <div class="form-field">
                    <label class="slider-label">Umbral de Confianza</label>
                    <mat-slider 
                      min="0.5" 
                      max="0.95" 
                      step="0.05" 
                      discrete
                      [displayWith]="formatSliderLabel">
                      <input matSliderThumb formControlName="confidenceThreshold">
                    </mat-slider>
                    <mat-hint>Valor: {{ formatPercentage(aiForm.get('confidenceThreshold')?.value) }}</mat-hint>
                  </div>
                </div>

                <div class="form-row">
                  <div class="form-field">
                    <label class="slider-label">Umbral de Detección</label>
                    <mat-slider 
                      min="0.3" 
                      max="0.8" 
                      step="0.05" 
                      discrete
                      [displayWith]="formatSliderLabel">
                      <input matSliderThumb formControlName="detectionThreshold">
                    </mat-slider>
                    <mat-hint>Valor: {{ formatPercentage(aiForm.get('detectionThreshold')?.value) }}</mat-hint>
                  </div>

                  <mat-form-field appearance="outline" class="form-field">
                    <mat-label>FPS Máximo</mat-label>
                    <input matInput type="number" formControlName="maxFramesPerSecond" min="15" max="60">
                    <mat-hint>Frames por segundo</mat-hint>
                  </mat-form-field>
                </div>
                
              </mat-card-content>
            </mat-card>

            <!-- Error Classification -->
            <mat-card class="config-card">
              <mat-card-header>
                <mat-card-title>
                  <mat-icon>warning</mat-icon>
                  Clasificación de Errores
                </mat-card-title>
              </mat-card-header>
              <mat-card-content>
                
                <div class="form-row">
                  <div class="form-field critical">
                    <label class="slider-label">Umbral Crítico</label>
                    <mat-slider 
                      min="0.8" 
                      max="1.0" 
                      step="0.05" 
                      discrete
                      [displayWith]="formatSliderLabel">
                      <input matSliderThumb formControlName="criticalThreshold">
                    </mat-slider>
                    <mat-hint>Errores críticos: {{ formatPercentage(aiForm.get('criticalThreshold')?.value) }}</mat-hint>
                  </div>

                  <div class="form-field high">
                    <label class="slider-label">Umbral Alto</label>
                    <mat-slider 
                      min="0.6" 
                      max="0.8" 
                      step="0.05" 
                      discrete
                      [displayWith]="formatSliderLabel">
                      <input matSliderThumb formControlName="highThreshold">
                    </mat-slider>
                    <mat-hint>Errores altos: {{ formatPercentage(aiForm.get('highThreshold')?.value) }}</mat-hint>
                  </div>
                </div>

                <div class="form-row">
                  <div class="form-field medium">
                    <label class="slider-label">Umbral Medio</label>
                    <mat-slider 
                      min="0.4" 
                      max="0.6" 
                      step="0.05" 
                      discrete
                      [displayWith]="formatSliderLabel">
                      <input matSliderThumb formControlName="mediumThreshold">
                    </mat-slider>
                    <mat-hint>Errores medios: {{ formatPercentage(aiForm.get('mediumThreshold')?.value) }}</mat-hint>
                  </div>

                  <div class="form-field low">
                    <label class="slider-label">Umbral Bajo</label>
                    <mat-slider 
                      min="0.2" 
                      max="0.4" 
                      step="0.05" 
                      discrete
                      [displayWith]="formatSliderLabel">
                      <input matSliderThumb formControlName="lowThreshold">
                    </mat-slider>
                    <mat-hint>Errores bajos: {{ formatPercentage(aiForm.get('lowThreshold')?.value) }}</mat-hint>
                  </div>
                </div>
                
              </mat-card-content>
            </mat-card>

            <!-- GPT Configuration -->
            <mat-card class="config-card">
              <mat-card-header>
                <mat-card-title>
                  <mat-icon>auto_awesome</mat-icon>
                  Configuración GPT-4
                </mat-card-title>
              </mat-card-header>
              <mat-card-content>
                
                <div class="form-row">
                  <div class="form-field">
                    <label class="slider-label">Creatividad GPT</label>
                    <mat-slider 
                      min="0.1" 
                      max="1.0" 
                      step="0.1" 
                      discrete
                      [displayWith]="formatSliderLabel">
                      <input matSliderThumb formControlName="gptCreativity">
                    </mat-slider>
                    <mat-hint>Temperature: {{ formatPercentage(aiForm.get('gptCreativity')?.value) }}</mat-hint>
                  </div>

                  <mat-form-field appearance="outline" class="form-field">
                    <mat-label>Longitud de Respuesta</mat-label>
                    <input matInput type="number" formControlName="gptResponseLength" min="100" max="1000">
                    <mat-hint>Tokens máximos</mat-hint>
                  </mat-form-field>
                </div>

                <div class="form-row">
                  <div class="form-field">
                    <label class="slider-label">Auto-aprobación</label>
                    <mat-slider 
                      min="0.75" 
                      max="0.95" 
                      step="0.05" 
                      discrete
                      [displayWith]="formatSliderLabel">
                      <input matSliderThumb formControlName="autoApprovalThreshold">
                    </mat-slider>
                    <mat-hint>Umbral: {{ formatPercentage(aiForm.get('autoApprovalThreshold')?.value) }}</mat-hint>
                  </div>

                  <mat-form-field appearance="outline" class="form-field">
                    <mat-label>Intervalo de Procesamiento</mat-label>
                    <input matInput type="number" formControlName="processingInterval" min="100" max="1000">
                    <mat-hint>Milisegundos</mat-hint>
                  </mat-form-field>
                </div>
                
              </mat-card-content>
            </mat-card>

            <div class="form-actions">
              <button mat-raised-button 
                      type="button" 
                      class="save-btn" 
                      [disabled]="aiForm.invalid || isLoading"
                      (click)="saveAISettings()">
                <mat-icon>save</mat-icon>
                Guardar Configuración IA
              </button>
            </div>
            
          </form>
        </div>
      </mat-tab>

      <!-- TAB 2: GIMNASIO -->
      <mat-tab>
        <ng-template mat-tab-label>
          <mat-icon>fitness_center</mat-icon>
          <span>Gimnasio</span>
        </ng-template>
        
        <div class="tab-content">
          <form [formGroup]="gymForm" class="settings-form">
            
            <div class="section-header">
              <h3>
                <mat-icon>business</mat-icon>
                Información del Gimnasio
              </h3>
              <p>Configura los datos del establecimiento GYMSHARK</p>
            </div>

            <mat-card class="config-card">
              <mat-card-header>
                <mat-card-title>
                  <mat-icon>info</mat-icon>
                  Información Básica
                </mat-card-title>
              </mat-card-header>
              <mat-card-content>
                
                <div class="form-row">
                  <mat-form-field appearance="outline" class="form-field">
                    <mat-label>Nombre del Gimnasio</mat-label>
                    <input matInput formControlName="name" required>
                    <mat-hint>Nombre comercial</mat-hint>
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="form-field">
                    <mat-label>Email</mat-label>
                    <input matInput type="email" formControlName="email" required>
                    <mat-hint>Correo electrónico</mat-hint>
                  </mat-form-field>
                </div>

                <div class="form-row">
                  <mat-form-field appearance="outline" class="form-field">
                    <mat-label>Teléfono</mat-label>
                    <input matInput formControlName="phone" required>
                    <mat-hint>Número de contacto</mat-hint>
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="form-field full-width">
                    <mat-label>Dirección</mat-label>
                    <textarea matInput formControlName="address" rows="2" required></textarea>
                    <mat-hint>Dirección física</mat-hint>
                  </mat-form-field>
                </div>
                
              </mat-card-content>
            </mat-card>

            <mat-card class="config-card">
              <mat-card-header>
                <mat-card-title>
                  <mat-icon>schedule</mat-icon>
                  Configuración Operativa
                </mat-card-title>
              </mat-card-header>
              <mat-card-content>
                
                <div class="form-row">
                  <mat-form-field appearance="outline" class="form-field">
                    <mat-label>Hora Apertura</mat-label>
                    <input matInput type="time" formControlName="openTime" required>
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="form-field">
                    <mat-label>Hora Cierre</mat-label>
                    <input matInput type="time" formControlName="closeTime" required>
                  </mat-form-field>
                </div>

                <div class="form-row">
                  <mat-form-field appearance="outline" class="form-field">
                    <mat-label>Días de Operación</mat-label>
                    <mat-select formControlName="operatingDays" multiple>
                      <mat-option *ngFor="let day of operatingDaysOptions" [value]="day.value">
                        {{ day.label }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="form-field">
                    <mat-label>Usuarios Máximos</mat-label>
                    <input matInput type="number" formControlName="maxUsers" min="1" required>
                  </mat-form-field>
                </div>

                <div class="form-row">
                  <mat-form-field appearance="outline" class="form-field">
                    <mat-label>Entrenadores Máximos</mat-label>
                    <input matInput type="number" formControlName="maxTrainers" min="1" required>
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="form-field">
                    <mat-label>Duración Sesión (min)</mat-label>
                    <input matInput type="number" formControlName="maxSessionDuration" min="30" required>
                  </mat-form-field>
                </div>

                <div class="maintenance-toggle">
                  <mat-slide-toggle formControlName="maintenanceMode">
                    <mat-icon>construction</mat-icon>
                    Modo Mantenimiento
                  </mat-slide-toggle>
                </div>
                
              </mat-card-content>
            </mat-card>

            <div class="form-actions">
              <button mat-raised-button 
                      type="button" 
                      class="save-btn" 
                      [disabled]="gymForm.invalid || isLoading"
                      (click)="saveGymSettings()">
                <mat-icon>save</mat-icon>
                Guardar Configuración Gimnasio
              </button>
            </div>
            
          </form>
        </div>
      </mat-tab>

      <!-- TAB 3: NOTIFICACIONES -->
      <mat-tab>
        <ng-template mat-tab-label>
          <mat-icon>notifications</mat-icon>
          <span>Notificaciones</span>
        </ng-template>
        
        <div class="tab-content">
          <form [formGroup]="notificationForm" class="settings-form">
            
            <div class="section-header">
              <h3>
                <mat-icon>campaign</mat-icon>
                Gestión de Notificaciones
              </h3>
              <p>Configura alertas del sistema</p>
            </div>

            <mat-card class="config-card">
              <mat-card-content>
                
                <div class="toggle-group">
                  <div class="toggle-row">
                    <mat-slide-toggle formControlName="enableCriticalAlerts">
                      <mat-icon>error</mat-icon>
                      Alertas Críticas
                    </mat-slide-toggle>
                  </div>

                  <div class="toggle-row">
                    <mat-slide-toggle formControlName="criticalAlertSound">
                      <mat-icon>volume_up</mat-icon>
                      Sonido Alertas
                    </mat-slide-toggle>
                  </div>

                  <div class="toggle-row">
                    <mat-slide-toggle formControlName="criticalAlertEmail">
                      <mat-icon>email</mat-icon>
                      Email Alertas
                    </mat-slide-toggle>
                  </div>

                  <div class="toggle-row">
                    <mat-slide-toggle formControlName="criticalAlertSMS">
                      <mat-icon>sms</mat-icon>
                      SMS Alertas
                    </mat-slide-toggle>
                  </div>

                  <div class="toggle-row">
                    <mat-slide-toggle formControlName="enableSystemNotifications">
                      <mat-icon>notifications_active</mat-icon>
                      Notificaciones Sistema
                    </mat-slide-toggle>
                  </div>

                  <div class="toggle-row">
                    <mat-slide-toggle formControlName="dailyReports">
                      <mat-icon>today</mat-icon>
                      Reportes Diarios
                    </mat-slide-toggle>
                  </div>

                  <div class="toggle-row">
                    <mat-slide-toggle formControlName="weeklyReports">
                      <mat-icon>date_range</mat-icon>
                      Reportes Semanales
                    </mat-slide-toggle>
                  </div>

                  <div class="toggle-row">
                    <mat-slide-toggle formControlName="monthlyReports">
                      <mat-icon>calendar_month</mat-icon>
                      Reportes Mensuales
                    </mat-slide-toggle>
                  </div>
                </div>
                
              </mat-card-content>
            </mat-card>

            <div class="form-actions">
              <button mat-raised-button 
                      type="button" 
                      class="save-btn" 
                      [disabled]="notificationForm.invalid || isLoading"
                      (click)="saveNotificationSettings()">
                <mat-icon>save</mat-icon>
                Guardar Notificaciones
              </button>
            </div>
            
          </form>
        </div>
      </mat-tab>

      <!-- TAB 4: BACKUP -->
      <mat-tab>
        <ng-template mat-tab-label>
          <mat-icon>backup</mat-icon>
          <span>Backup</span>
        </ng-template>
        
        <div class="tab-content">
          <form [formGroup]="backupForm" class="settings-form">
            
            <div class="section-header">
              <h3>
                <mat-icon>cloud_upload</mat-icon>
                Respaldos
              </h3>
            </div>

            <mat-card class="config-card">
              <mat-card-content>
                
                <div class="toggle-row">
                  <mat-slide-toggle formControlName="enableAutoBackup">
                    <mat-icon>cloud_done</mat-icon>
                    Respaldos Automáticos
                  </mat-slide-toggle>
                </div>

                <div class="form-row">
                  <mat-form-field appearance="outline" class="form-field">
                    <mat-label>Frecuencia</mat-label>
                    <mat-select formControlName="backupFrequency">
                      <mat-option *ngFor="let freq of backupFrequencyOptions" [value]="freq.value">
                        {{ freq.label }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="form-field">
                    <mat-label>Hora</mat-label>
                    <input matInput type="time" formControlName="backupTime">
                  </mat-form-field>
                </div>

                <div class="form-row">
                  <mat-form-field appearance="outline" class="form-field">
                    <mat-label>Retención (días)</mat-label>
                    <input matInput type="number" formControlName="retentionDays" min="7" max="365">
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="form-field">
                    <mat-label>Ubicación</mat-label>
                    <mat-select formControlName="backupLocation">
                      <mat-option *ngFor="let loc of backupLocationOptions" [value]="loc.value">
                        {{ loc.label }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>
                </div>

                <div class="form-row">
                  <mat-form-field appearance="outline" class="form-field">
                    <mat-label>Tamaño Máximo (MB)</mat-label>
                    <input matInput type="number" formControlName="maxBackupSize" min="100" max="5000">
                  </mat-form-field>
                </div>

                <div class="toggle-group">
                  <div class="toggle-row">
                    <mat-slide-toggle formControlName="includeUserData">
                      Incluir Datos Usuarios
                    </mat-slide-toggle>
                  </div>

                  <div class="toggle-row">
                    <mat-slide-toggle formControlName="includeAlerts">
                      Incluir Alertas
                    </mat-slide-toggle>
                  </div>

                  <div class="toggle-row">
                    <mat-slide-toggle formControlName="includeRoutines">
                      Incluir Rutinas
                    </mat-slide-toggle>
                  </div>

                  <div class="toggle-row">
                    <mat-slide-toggle formControlName="includeSettings">
                      Incluir Configuración
                    </mat-slide-toggle>
                  </div>
                </div>
                
              </mat-card-content>
            </mat-card>

            <div class="form-actions">
              <button mat-raised-button 
                      type="button" 
                      class="save-btn" 
                      [disabled]="backupForm.invalid || isLoading"
                      (click)="saveBackupSettings()">
                <mat-icon>save</mat-icon>
                Guardar Backup
              </button>
            </div>
            
          </form>
        </div>
      </mat-tab>

      <!-- TAB 5: SEGURIDAD -->
      <mat-tab>
        <ng-template mat-tab-label>
          <mat-icon>security</mat-icon>
          <span>Seguridad</span>
        </ng-template>
        
        <div class="tab-content">
          <form [formGroup]="securityForm" class="settings-form">
            
            <div class="section-header">
              <h3>
                <mat-icon>verified_user</mat-icon>
                Seguridad
              </h3>
            </div>

            <mat-card class="config-card">
              <mat-card-content>
                
                <div class="form-row">
                  <mat-form-field appearance="outline" class="form-field">
                    <mat-label>Timeout Sesión (min)</mat-label>
                    <input matInput type="number" formControlName="sessionTimeout" min="15" max="1440">
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="form-field">
                    <mat-label>Intentos Login Máx</mat-label>
                    <input matInput type="number" formControlName="maxLoginAttempts" min="3" max="10">
                  </mat-form-field>
                </div>

                <div class="form-row">
                  <mat-form-field appearance="outline" class="form-field">
                    <mat-label>Duración Bloqueo (min)</mat-label>
                    <input matInput type="number" formControlName="lockoutDuration" min="5" max="60">
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="form-field">
                    <mat-label>Longitud Mín Password</mat-label>
                    <input matInput type="number" formControlName="minPasswordLength" min="6" max="20">
                  </mat-form-field>
                </div>

                <div class="form-row">
                  <mat-form-field appearance="outline" class="form-field">
                    <mat-label>Expiración Password (días)</mat-label>
                    <input matInput type="number" formControlName="passwordExpiryDays" min="30" max="365">
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="form-field">
                    <mat-label>Retención Auditoría (días)</mat-label>
                    <input matInput type="number" formControlName="auditRetentionDays" min="30" max="365">
                  </mat-form-field>
                </div>

                <div class="toggle-group">
                  <div class="toggle-row">
                    <mat-slide-toggle formControlName="requirePasswordChange">
                      Requerir Cambio Password
                    </mat-slide-toggle>
                  </div>

                  <div class="toggle-row">
                    <mat-slide-toggle formControlName="requireSpecialChars">
                      Caracteres Especiales
                    </mat-slide-toggle>
                  </div>

                  <div class="toggle-row">
                    <mat-slide-toggle formControlName="allowMultipleSessions">
                      Múltiples Sesiones
                    </mat-slide-toggle>
                  </div>

                  <div class="toggle-row">
                    <mat-slide-toggle formControlName="enableTwoFactor">
                      Autenticación 2FA
                    </mat-slide-toggle>
                  </div>

                  <div class="toggle-row">
                    <mat-slide-toggle formControlName="enableAuditLog">
                      Registro Auditoría
                    </mat-slide-toggle>
                  </div>
                </div>
                
              </mat-card-content>
            </mat-card>

            <div class="form-actions">
              <button mat-raised-button 
                      type="button" 
                      class="save-btn" 
                      [disabled]="securityForm.invalid || isLoading"
                      (click)="saveSecuritySettings()">
                <mat-icon>save</mat-icon>
                Guardar Seguridad
              </button>
            </div>
            
          </form>
        </div>
      </mat-tab>

    </mat-tab-group>
    
  </div>

</div>