<!-- src/app/users/user-list/user-list.component.html -->
<!-- üë• GESTI√ìN COMPLETA DE USUARIOS - TEMPLATE MATERIAL DESIGN -->
<div class="back-navigation">
  <button mat-button 
          (click)="goBack()" 
          class="back-button">
    <mat-icon>arrow_back</mat-icon>
    <span>Volver al Dashboard</span>
  </button>
</div>

<div class="user-management-container">
  
  <!-- ‚úÖ HEADER CON M√âTRICAS GLOBALES -->
  <div class="metrics-header">
    <div class="page-title-section">
      <h1 class="page-title">
        <mat-icon>people</mat-icon>
        Gesti√≥n de Usuarios M√≥vil
      </h1>
      <p class="subtitle">Supervisa y gestiona usuarios de la aplicaci√≥n m√≥vil FitNova</p>
    </div>
    
    <!-- üö® BOT√ìN CREAR USUARIO - ARREGLADO PARA AMBOS ROLES -->
    <div class="header-actions">
      <button mat-raised-button 
              color="primary"
              (click)="toggleCreateUserForm()"
              *ngIf="currentUser?.role === 'admin' || currentUser?.role === 'trainer'">
        <mat-icon>person_add</mat-icon>
        <span *ngIf="currentUser?.role === 'admin'">Crear Nuevo Usuario</span>
        <span *ngIf="currentUser?.role === 'trainer'">Registrar Usuario</span>
      </button>

      <button mat-button 
              (click)="refreshData()">
        <mat-icon>refresh</mat-icon>
        Actualizar
      </button>

      <button mat-button 
              (click)="exportData()">
        <mat-icon>file_download</mat-icon>
        Exportar
      </button>

      <!-- DEBUG BUTTON - REMOVER EN PRODUCCI√ìN -->
      <button mat-button 
              color="warn"
              (click)="debugCurrentUser()"
              style="opacity: 0.7; font-size: 12px;">
        üêõ Debug
      </button>
    </div>
    
    <div class="metrics-cards">
      <mat-card class="metric-card primary">
        <mat-card-content>
          <div class="metric-content">
            <mat-icon>group</mat-icon>
            <div class="metric-text">
              <span class="metric-value">{{totalUsers}}</span>
              <span class="metric-label">Total Usuarios</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="metric-card accent">
        <mat-card-content>
          <div class="metric-content">
            <mat-icon>flash_on</mat-icon>
            <div class="metric-text">
              <span class="metric-value">{{activeUsersToday}}</span>
              <span class="metric-label">Activos Hoy</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="metric-card warn">
        <mat-card-content>
          <div class="metric-content">
            <mat-icon>person_off</mat-icon>
            <div class="metric-text">
              <span class="metric-value">{{usersWithoutTrainer}}</span>
              <span class="metric-label">Sin Entrenador</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="metric-card success">
        <mat-card-content>
          <div class="metric-content">
            <mat-icon>fitness_center</mat-icon>
            <div class="metric-text">
              <span class="metric-value">{{totalWorkoutsAllUsers}}</span>
              <span class="metric-label">Total Entrenamientos</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>

  <!-- üö® MODAL CREAR USUARIO - ARREGLADO PARA AMBOS ROLES -->
  <div class="create-user-section" *ngIf="showCreateForm && (currentUser?.role === 'admin' || currentUser?.role === 'trainer')">
    <mat-card class="create-user-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>person_add</mat-icon>
          <span *ngIf="currentUser?.role === 'admin'">Crear Nuevo Usuario M√≥vil</span>
          <span *ngIf="currentUser?.role === 'trainer'">Registrar Usuario para Entrenamiento</span>
        </mat-card-title>
        <mat-card-subtitle>
          <span *ngIf="currentUser?.role === 'admin'">Los usuarios creados podr√°n usar la aplicaci√≥n m√≥vil FitNova</span>
          <span *ngIf="currentUser?.role === 'trainer'">El usuario ser√° asignado autom√°ticamente a ti como entrenador</span>
        </mat-card-subtitle>
      </mat-card-header>
      
      <mat-card-content>
        <form [formGroup]="createUserForm" 
              (ngSubmit)="createUser()"
              class="create-user-form">
          
          <div class="form-row">
            <mat-form-field appearance="outline">
              <mat-label>Nombre completo</mat-label>
              <input matInput 
                     formControlName="displayName"
                     placeholder="Juan P√©rez">
              <mat-error *ngIf="createUserForm.get('displayName')?.hasError('required')">
                El nombre es requerido
              </mat-error>
              <mat-error *ngIf="createUserForm.get('displayName')?.hasError('minlength')">
                M√≠nimo 2 caracteres
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Email</mat-label>
              <input matInput 
                     type="email"
                     formControlName="email"
                     placeholder="juan@example.com">
              <mat-error *ngIf="createUserForm.get('email')?.hasError('required')">
                El email es requerido
              </mat-error>
              <mat-error *ngIf="createUserForm.get('email')?.hasError('email')">
                Formato de email inv√°lido
              </mat-error>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline">
              <mat-label>Contrase√±a</mat-label>
              <input matInput 
                     type="password"
                     formControlName="password"
                     placeholder="M√≠nimo 6 caracteres">
              <mat-error *ngIf="createUserForm.get('password')?.hasError('required')">
                La contrase√±a es requerida
              </mat-error>
              <mat-error *ngIf="createUserForm.get('password')?.hasError('minlength')">
                M√≠nimo 6 caracteres
              </mat-error>
            </mat-form-field>

            <!-- Entrenador asignado - Solo para admins -->
            <mat-form-field appearance="outline" *ngIf="currentUser?.role === 'admin'">
              <mat-label>Entrenador asignado</mat-label>
              <mat-select formControlName="assignedTrainer">
                <mat-option value="">Sin asignar</mat-option>
                <mat-option *ngFor="let trainer of availableTrainers" 
                           [value]="trainer.uid">
                  {{trainer.displayName}}
                </mat-option>
              </mat-select>
            </mat-form-field>

            <!-- Info para trainers -->
            <div class="trainer-info" *ngIf="currentUser?.role === 'trainer'">
              <mat-icon>info</mat-icon>
              <span>Este usuario ser√° asignado autom√°ticamente a ti como entrenador</span>
            </div>
          </div>

          <div class="form-actions">
            <button mat-raised-button 
                    color="primary"
                    type="submit"
                    [disabled]="createUserForm.invalid || isLoading">
              <mat-spinner diameter="20" *ngIf="isLoading"></mat-spinner>
              <mat-icon *ngIf="!isLoading">add</mat-icon>
              <span *ngIf="!isLoading && currentUser?.role === 'admin'">Crear Usuario</span>
              <span *ngIf="!isLoading && currentUser?.role === 'trainer'">Registrar Usuario</span>
              <span *ngIf="isLoading">Creando...</span>
            </button>

            <button mat-button 
                    type="button"
                    (click)="toggleCreateUserForm()"
                    [disabled]="isLoading">
              <mat-icon>cancel</mat-icon>
              Cancelar
            </button>
          </div>

        </form>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- ‚úÖ CONTROLES Y FILTROS -->
  <mat-card class="controls-card">
    <mat-card-content>
      <div class="controls-section">
        
        <!-- B√∫squeda y acciones principales -->
        <div class="search-actions">
          <mat-form-field class="search-field" appearance="outline">
            <mat-label>Buscar usuarios</mat-label>
            <input matInput 
                   formControlName="searchText"
                   placeholder="Nombre, email..."
                   (input)="onSearchChange($event)">
            <mat-icon matSuffix>search</mat-icon>
          </mat-form-field>

          <div class="action-buttons">
            <button mat-button 
                    (click)="refreshData()">
              <mat-icon>refresh</mat-icon>
              Actualizar
            </button>

            <button mat-button 
                    (click)="exportData()">
              <mat-icon>file_download</mat-icon>
              Exportar
            </button>
          </div>
        </div>

        <!-- Filtros avanzados -->
        <div class="advanced-filters" [formGroup]="filterForm">
          <mat-form-field appearance="outline">
            <mat-label>Entrenador Asignado</mat-label>
            <mat-select formControlName="trainerFilter" (selectionChange)="onTrainerFilterChange()">
              <mat-option value="all">Todos los entrenadores</mat-option>
              <mat-option value="unassigned">Sin asignar</mat-option>
              <mat-option *ngFor="let trainer of availableTrainers" 
                         [value]="trainer.uid">
                {{trainer.displayName}}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Actividad</mat-label>
            <mat-select formControlName="activityFilter" (selectionChange)="onActivityFilterChange()">
              <mat-option value="all">Toda la actividad</mat-option>
              <mat-option value="today">Activos hoy</mat-option>
              <mat-option value="week">√öltima semana</mat-option>
              <mat-option value="month">√öltimo mes</mat-option>
              <mat-option value="inactive">Inactivos</mat-option>
            </mat-select>
          </mat-form-field>

          <button mat-button 
                  color="warn"
                  (click)="clearFilters()">
            <mat-icon>clear</mat-icon>
            Limpiar Filtros
          </button>
        </div>

      </div>
    </mat-card-content>
  </mat-card>

  <!-- ‚úÖ TABLA DE USUARIOS -->
  <mat-card class="table-card">
    <mat-card-content>

      <!-- Loading state -->
      <div class="loading-container" *ngIf="isLoading">
        <mat-spinner diameter="50"></mat-spinner>
        <p>Cargando usuarios...</p>
      </div>

      <!-- Tabla con datos -->
      <div class="table-container" *ngIf="!isLoading">
        <table mat-table 
               [dataSource]="dataSource" 
               matSort 
               class="users-table"
               matSortActive="displayName"
               matSortDirection="asc">

          <!-- Columna: Usuario -->
          <ng-container matColumnDef="displayName">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Usuario</th>
            <td mat-cell *matCellDef="let user">
              <div class="user-info">
                <mat-icon class="user-avatar">person</mat-icon>
                <div class="user-details">
                  <strong>{{user.displayName}}</strong>
                  <small>ID: {{user.uid | slice:0:8}}...</small>
                </div>
              </div>
            </td>
          </ng-container>

          <!-- Columna: Email -->
          <ng-container matColumnDef="email">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Email</th>
            <td mat-cell *matCellDef="let user">
              <span class="email-text">{{user.email}}</span>
            </td>
          </ng-container>

          <!-- Columna: Estado -->
          <ng-container matColumnDef="statusText">
            <th mat-header-cell *matHeaderCellDef>Estado</th>
            <td mat-cell *matCellDef="let user">
              <mat-chip [color]="user.statusColor" selected>
                {{user.statusText}}
              </mat-chip>
            </td>
          </ng-container>

          <!-- Columna: Entrenamientos -->
          <ng-container matColumnDef="totalWorkouts">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Entrenamientos</th>
            <td mat-cell *matCellDef="let user">
              <div class="workout-cell">
                <mat-icon>fitness_center</mat-icon>
                <strong>{{user.totalWorkouts || 0}}</strong>
              </div>
            </td>
          </ng-container>

          <!-- Columna: Precisi√≥n -->
          <ng-container matColumnDef="averageAccuracy">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Precisi√≥n</th>
            <td mat-cell *matCellDef="let user">
              <div class="accuracy-cell">
                <mat-icon [style.color]="user.averageAccuracy > 80 ? '#4caf50' : user.averageAccuracy > 60 ? '#ff9800' : '#f44336'">
                  trending_up
                </mat-icon>
                <span>{{user.averageAccuracy || 0}}%</span>
              </div>
            </td>
          </ng-container>

          <!-- Columna: Errores Cr√≠ticos -->
          <ng-container matColumnDef="totalCriticalErrors">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Errores</th>
            <td mat-cell *matCellDef="let user">
              <div class="errors-cell">
                <mat-icon [style.color]="user.totalCriticalErrors > 10 ? '#f44336' : '#4caf50'">
                  warning
                </mat-icon>
                <span>{{user.totalCriticalErrors || 0}}</span>
              </div>
            </td>
          </ng-container>

          <!-- Columna: Entrenador -->
          <ng-container matColumnDef="assignedTrainerName">
            <th mat-header-cell *matHeaderCellDef>Entrenador</th>
            <td mat-cell *matCellDef="let user">
              <div class="trainer-cell">
                <mat-form-field appearance="outline" 
                                *ngIf="currentUser?.role === 'admin'">
                  <mat-select [value]="user.assignedTrainer || ''"
                              (selectionChange)="assignTrainer(user.uid, $event.value)">
                    <mat-option value="">Sin asignar</mat-option>
                    <mat-option *ngFor="let trainer of availableTrainers" 
                               [value]="trainer.uid">
                      {{trainer.displayName}}
                    </mat-option>
                  </mat-select>
                </mat-form-field>
                
                <span *ngIf="currentUser?.role === 'trainer'" 
                      class="trainer-name">
                  {{user.assignedTrainerName}}
                </span>
              </div>
            </td>
          </ng-container>

          <!-- Columna: √öltima Actividad -->
          <ng-container matColumnDef="lastActiveText">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>√öltima Actividad</th>
            <td mat-cell *matCellDef="let user">
              <div class="activity-cell">
                <mat-icon>schedule</mat-icon>
                <span>{{user.lastActiveText}}</span>
              </div>
            </td>
          </ng-container>

          <!-- Columna: Acciones -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Acciones</th>
            <td mat-cell *matCellDef="let user">
              <div class="actions-cell">
                <button mat-icon-button 
                        [matMenuTriggerFor]="userMenu"
                        matTooltip="M√°s opciones">
                  <mat-icon>more_vert</mat-icon>
                </button>
                
                <mat-menu #userMenu="matMenu">
                  <button mat-menu-item 
                          (click)="viewUserDetail(user.uid)">
                    <mat-icon>visibility</mat-icon>
                    Ver Detalles
                  </button>
                  
                  <button mat-menu-item 
                          (click)="editUser(user.uid)">
                    <mat-icon>edit</mat-icon>
                    Editar Usuario
                  </button>
                  
                  <button mat-menu-item 
                          (click)="viewUserStats(user.uid)">
                    <mat-icon>analytics</mat-icon>
                    Ver Estad√≠sticas
                  </button>
                  
                  <mat-divider></mat-divider>
                  
                  <button mat-menu-item 
                          (click)="resetUserPassword(user.uid)"
                          *ngIf="currentUser?.role === 'admin'">
                    <mat-icon>lock_reset</mat-icon>
                    Resetear Contrase√±a
                  </button>
                  
                  <button mat-menu-item 
                          (click)="deleteUser(user.uid)"
                          *ngIf="currentUser?.role === 'admin'"
                          class="delete-action">
                    <mat-icon>delete</mat-icon>
                    Desactivar Usuario
                  </button>
                </mat-menu>
              </div>
            </td>
          </ng-container>

          <!-- Header y filas de la tabla -->
          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"
              class="user-row"
              [class.inactive-user]="row.statusColor === 'warn'"></tr>

        </table>

        <!-- Paginador -->
        <mat-paginator [pageSizeOptions]="[10, 25, 50, 100]"
                       [pageSize]="25"
                       showFirstLastButtons>
        </mat-paginator>

      </div>

      <!-- Estado vac√≠o -->
      <div class="empty-state" *ngIf="!isLoading && dataSource.data.length === 0">
        <mat-icon class="empty-icon">people_outline</mat-icon>
        <h3>No se encontraron usuarios</h3>
        <p>No hay usuarios que coincidan con los filtros aplicados</p>
        <button mat-raised-button 
                color="primary"
                (click)="clearFilters()">
          <mat-icon>clear</mat-icon>
          Limpiar Filtros
        </button>
      </div>

    </mat-card-content>
  </mat-card>

</div>