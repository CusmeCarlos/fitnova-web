<!-- src/app/users/user-list/user-list.component.html -->
<!-- üë• GESTI√ìN DE USUARIOS - TEMPLATE PREMIUM FINZENAPP -->
<div class="user-management-container">
  
  <!-- üîô NAVEGACI√ìN ATR√ÅS -->
  <div class="back-navigation">
    <button mat-button 
            (click)="goBack()" 
            class="back-button">
      <mat-icon>arrow_back</mat-icon>
      <span>Volver al Dashboard</span>
    </button>
  </div>

  <!-- ‚úÖ HEADER CON M√âTRICAS GLOBALES -->
  <div class="metrics-header">
    <div class="page-title-section">
      <div>
        <h1 class="page-title">
          <mat-icon>people</mat-icon>
          Gesti√≥n de Usuarios
        </h1>
        <p class="subtitle">Supervisa y gestiona usuarios de la aplicaci√≥n m√≥vil FitNova</p>
      </div>
    </div>
    
    <!-- üöÄ HEADER ACTIONS -->
    <div class="header-actions">
      <button mat-raised-button 
              color="primary"
              (click)="toggleCreateUserForm()"
              *ngIf="currentUser?.role === 'admin' || currentUser?.role === 'trainer'">
        <mat-icon>person_add</mat-icon>
        <span *ngIf="currentUser?.role === 'admin'">Crear Usuario</span>
        <span *ngIf="currentUser?.role === 'trainer'">Registrar Usuario</span>
      </button>

      <button mat-button (click)="forceUpdateActivity()" 
              matTooltip="Actualizar mi estado a EN L√çNEA">
        <mat-icon>sync</mat-icon>
        <span>Actualizar Estado</span>
      </button>

      <button mat-button (click)="refreshData()">
        <mat-icon>refresh</mat-icon>
        <span>Actualizar</span>
      </button>

      <button mat-button (click)="exportData()">
        <mat-icon>file_download</mat-icon>
        <span>Exportar</span>
      </button>
    </div>

    <!-- üìä M√âTRICAS CARDS -->
    <div class="metrics-cards">
      <mat-card class="metric-card primary">
        <mat-card-content>
          <div class="metric-content">
            <mat-icon>group</mat-icon>
            <div class="metric-text">
              <span class="metric-value">{{totalUsers}}</span>
              <span class="metric-label">Total Usuarios</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="metric-card accent">
        <mat-card-content>
          <div class="metric-content">
            <mat-icon>flash_on</mat-icon>
            <div class="metric-text">
              <span class="metric-value">{{activeUsersToday}}</span>
              <span class="metric-label">Activos Hoy</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="metric-card warn">
        <mat-card-content>
          <div class="metric-content">
            <mat-icon>trending_up</mat-icon>
            <div class="metric-text">
              <span class="metric-value">{{newUsersThisMonth}}</span>
              <span class="metric-label">Nuevos Este Mes</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="metric-card primary">
        <mat-card-content>
          <div class="metric-content">
            <mat-icon>fitness_center</mat-icon>
            <div class="metric-text">
              <span class="metric-value">{{totalWorkoutsCompleted}}</span>
              <span class="metric-label">Entrenamientos</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>

  <!-- üéõÔ∏è CONTROLES Y FILTROS -->
  <mat-card class="controls-card">
    <mat-card-content>
      <div class="controls-section">
        <div class="search-actions">
          <mat-form-field class="search-field" appearance="outline">
            <mat-label>Buscar usuarios</mat-label>
            <input matInput 
                   [(ngModel)]="searchTerm" 
                   (input)="applySearch()"
                   placeholder="Buscar por nombre, email o ID...">
            <mat-icon matPrefix>search</mat-icon>
            <button matSuffix 
                    mat-icon-button 
                    (click)="clearSearch()" 
                    *ngIf="searchTerm"
                    aria-label="Limpiar b√∫squeda">
              <mat-icon>close</mat-icon>
            </button>
          </mat-form-field>
          
          <div class="action-buttons">
            <button mat-button (click)="toggleAdvancedFilters()">
              <mat-icon>filter_list</mat-icon>
              <span>Filtros</span>
            </button>
            
            <button mat-button 
                    (click)="clearAllFilters()"
                    [disabled]="!hasActiveFilters()">
              <mat-icon>clear_all</mat-icon>
              <span>Limpiar</span>
            </button>
          </div>
        </div>
        
        <!-- Filtros Avanzados -->
        <div class="advanced-filters" *ngIf="showAdvancedFilters">
          <mat-form-field appearance="outline">
            <mat-label>Estado</mat-label>
            <mat-select [(ngModel)]="statusFilter" (selectionChange)="applyFilters()">
              <mat-option value="">Todos</mat-option>
              <mat-option value="active">Activos</mat-option>
              <mat-option value="inactive">Inactivos</mat-option>
              <mat-option value="blocked">Bloqueados</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" *ngIf="currentUser?.role === 'admin'">
            <mat-label>Entrenador</mat-label>
            <mat-select [(ngModel)]="trainerFilter" (selectionChange)="applyFilters()">
              <mat-option value="">Todos</mat-option>
              <mat-option value="unassigned">Sin asignar</mat-option>
              <mat-option *ngFor="let trainer of availableTrainers" 
                         [value]="trainer.uid">
                {{trainer.displayName}}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Desde</mat-label>
            <input matInput 
                   [matDatepicker]="startPicker" 
                   [(ngModel)]="dateRangeStart"
                   (dateChange)="applyFilters()">
            <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
            <mat-datepicker #startPicker></mat-datepicker>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Hasta</mat-label>
            <input matInput 
                   [matDatepicker]="endPicker" 
                   [(ngModel)]="dateRangeEnd"
                   (dateChange)="applyFilters()">
            <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
            <mat-datepicker #endPicker></mat-datepicker>
          </mat-form-field>

          <button mat-button (click)="resetDateFilters()">
            <mat-icon>date_range</mat-icon>
            <span>Resetear fechas</span>
          </button>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- üìã TABLA DE USUARIOS -->
  <mat-card class="table-card">
    <!-- Loading State -->
    <div class="loading-container" *ngIf="isLoading">
      <mat-spinner diameter="50"></mat-spinner>
    </div>

    <!-- Contenido de la tabla -->
    <div *ngIf="!isLoading">
      <!-- Estado vac√≠o -->
      <div class="empty-state" *ngIf="dataSource.data.length === 0 && !isLoading">
        <mat-icon class="empty-icon">people_outline</mat-icon>
        <h3>No hay usuarios disponibles</h3>
        <p *ngIf="!hasActiveFilters()">
          A√∫n no tienes usuarios registrados en tu aplicaci√≥n. 
          ¬°Comienza creando el primer usuario!
        </p>
        <p *ngIf="hasActiveFilters()">
          No se encontraron usuarios que coincidan con los filtros aplicados. 
          Intenta ajustar los criterios de b√∫squeda.
        </p>
        <button mat-raised-button 
                color="primary"
                (click)="toggleCreateUserForm()"
                *ngIf="!hasActiveFilters() && (currentUser?.role === 'admin' || currentUser?.role === 'trainer')">
          <mat-icon>person_add</mat-icon>
          Crear Primer Usuario
        </button>
        <button mat-button 
                (click)="clearAllFilters()"
                *ngIf="hasActiveFilters()">
          <mat-icon>clear_all</mat-icon>
          Limpiar Filtros
        </button>
      </div>

      <!-- Tabla de usuarios -->
      <div class="table-container" *ngIf="dataSource.data.length > 0">
        <table mat-table 
               [dataSource]="dataSource" 
               matSort 
               class="users-table">

          <!-- Columna: Informaci√≥n del Usuario -->
          <ng-container matColumnDef="userInfo">
            <th mat-header-cell *matHeaderCellDef mat-sort-header="displayName">
              Usuario
            </th>
            <td mat-cell *matCellDef="let user" class="user-info-cell">
              <div class="user-info">
                <div class="user-avatar">
                  {{getUserInitials(user.displayName)}}
                </div>
                <div class="user-details">
                  <div class="user-name">{{user.displayName}}</div>
                  <div class="user-email">{{user.email}}</div>
                </div>
              </div>
            </td>
          </ng-container>

          <!-- Columna: Estado -->
          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef mat-sort-header="status">
              Estado
            </th>
            <td mat-cell *matCellDef="let user" class="status-cell">
              <div class="status-chip" 
                   [ngClass]="{
                     'status-active': user.statusColor === 'primary' || user.statusColor === 'accent',
                     'status-inactive': user.statusColor === 'warn' || user.statusText.includes('Inactivo'),
                     'status-blocked': user.status === 'blocked'
                   }">
                <div class="status-dot"></div>
                <span>{{user.statusText}}</span>
              </div>
            </td>
          </ng-container>

          <!-- Columna: √öltima Actividad -->
          <ng-container matColumnDef="lastActive">
            <th mat-header-cell *matHeaderCellDef mat-sort-header="lastActiveAt">
              √öltima Actividad
            </th>
            <td mat-cell *matCellDef="let user">
              <div class="last-active-info">
                <span class="activity-date">{{user.lastActiveText}}</span>
                <span class="activity-details" *ngIf="user.totalWorkouts > 0">
                  {{user.totalWorkouts}} entrenamientos
                </span>
              </div>
            </td>
          </ng-container>

          <!-- Columna: Estad√≠sticas -->
          <ng-container matColumnDef="stats">
            <th mat-header-cell *matHeaderCellDef>
              Estad√≠sticas
            </th>
            <td mat-cell *matCellDef="let user">
              <div class="user-stats">
                <div class="stat-item">
                  <mat-icon>fitness_center</mat-icon>
                  <span>{{user.totalWorkouts || 0}}</span>
                </div>
                <div class="stat-item">
                  <mat-icon>schedule</mat-icon>
                  <span>{{formatMinutes(user.totalMinutes || 0)}}</span>
                </div>
                <div class="stat-item" *ngIf="user.avgAccuracy">
                  <mat-icon>target</mat-icon>
                  <span>{{user.avgAccuracy}}%</span>
                </div>
              </div>
            </td>
          </ng-container>

          <!-- Columna: Entrenador Asignado (solo Admin) -->
          <ng-container matColumnDef="assignedTrainer" *ngIf="currentUser?.role === 'admin'">
            <th mat-header-cell *matHeaderCellDef>
              Entrenador
            </th>
            <td mat-cell *matCellDef="let user" class="trainer-cell">
              <mat-form-field appearance="outline" *ngIf="!user.isUpdatingTrainer">
                <mat-select [value]="user.assignedTrainer || ''" 
                           (selectionChange)="updateAssignedTrainer(user, $event.value)"
                           [disabled]="user.isUpdatingTrainer">
                  <mat-option value="">Sin asignar</mat-option>
                  <mat-option *ngFor="let trainer of availableTrainers" 
                             [value]="trainer.uid">
                    {{trainer.displayName}}
                  </mat-option>
                </mat-select>
              </mat-form-field>
              <div *ngIf="user.isUpdatingTrainer" class="updating-trainer">
                <mat-spinner diameter="24"></mat-spinner>
                <span>Actualizando...</span>
              </div>
              <div class="trainer-name" *ngIf="user.assignedTrainerName && !user.isUpdatingTrainer">
                {{user.assignedTrainerName}}
              </div>
            </td>
          </ng-container>

          <!-- Columna: Acciones -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>
              Acciones
            </th>
            <td mat-cell *matCellDef="let user" class="actions-cell">
              <button mat-icon-button 
                      [matMenuTriggerFor]="userActionsMenu"
                      [disabled]="user.isUpdating"
                      matTooltip="M√°s acciones">
                <mat-icon>more_vert</mat-icon>
              </button>
              
              <!-- Men√∫ de acciones -->
              <mat-menu #userActionsMenu="matMenu">
                <button mat-menu-item (click)="viewUserDetails(user)">
                  <mat-icon>visibility</mat-icon>
                  <span>Ver detalles</span>
                </button>
                
                <button mat-menu-item (click)="editUser(user)">
                  <mat-icon>edit</mat-icon>
                  <span>Editar</span>
                </button>
                
                <button mat-menu-item 
                        (click)="toggleUserStatus(user)"
                        [disabled]="user.isUpdating">
                  <mat-icon>{{user.status === 'active' ? 'block' : 'check_circle'}}</mat-icon>
                  <span>{{user.status === 'active' ? 'Desactivar' : 'Activar'}}</span>
                </button>
                
                <mat-divider></mat-divider>
                
                <button mat-menu-item 
                        (click)="resetUserPassword(user)"
                        class="warning-action">
                  <mat-icon>lock_reset</mat-icon>
                  <span>Resetear contrase√±a</span>
                </button>
                
                <button mat-menu-item 
                        (click)="deleteUser(user)"
                        class="delete-action"
                        *ngIf="currentUser?.role === 'admin'">
                  <mat-icon>delete</mat-icon>
                  <span>Eliminar</span>
                </button>
              </mat-menu>
            </td>
          </ng-container>

          <!-- Definici√≥n de filas -->
          <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
          <tr mat-row 
              *matRowDef="let user; columns: displayedColumns;" 
              class="user-row"
              [class.inactive-user]="user.status !== 'active'"></tr>
        </table>

        <!-- Paginador -->
        <mat-paginator 
          [pageSizeOptions]="[10, 25, 50, 100]"
          [pageSize]="25"
          showFirstLastButtons
          aria-label="Seleccionar p√°gina de usuarios">
        </mat-paginator>
      </div>
    </div>
  </mat-card>

  <!-- üö® FORMULARIO DE CREAR USUARIO (Modal o Expansible) -->
  <mat-card *ngIf="showCreateUserForm" class="create-user-form">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>person_add</mat-icon>
        Crear Nuevo Usuario
      </mat-card-title>
    </mat-card-header>
    
    <mat-card-content>
      <form [formGroup]="createUserForm" (ngSubmit)="createUser()">
        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Nombre completo</mat-label>
            <input matInput 
                   formControlName="displayName" 
                   placeholder="Ej: Juan P√©rez"
                   required>
            <mat-error *ngIf="createUserForm.get('displayName')?.hasError('required')">
              El nombre es requerido
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Email</mat-label>
            <input matInput 
                   type="email"
                   formControlName="email" 
                   placeholder="usuario@ejemplo.com"
                   required>
            <mat-error *ngIf="createUserForm.get('email')?.hasError('required')">
              El email es requerido
            </mat-error>
            <mat-error *ngIf="createUserForm.get('email')?.hasError('email')">
              Ingresa un email v√°lido
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Contrase√±a temporal</mat-label>
            <input matInput 
                   [type]="hidePassword ? 'password' : 'text'"
                   formControlName="password" 
                   placeholder="M√≠nimo 6 caracteres"
                   required>
            <button mat-icon-button 
                    matSuffix 
                    (click)="hidePassword = !hidePassword"
                    type="button">
              <mat-icon>{{hidePassword ? 'visibility' : 'visibility_off'}}</mat-icon>
            </button>
            <mat-error *ngIf="createUserForm.get('password')?.hasError('required')">
              La contrase√±a es requerida
            </mat-error>
            <mat-error *ngIf="createUserForm.get('password')?.hasError('minlength')">
              M√≠nimo 6 caracteres
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" *ngIf="currentUser?.role === 'admin'">
            <mat-label>Asignar entrenador</mat-label>
            <mat-select formControlName="assignedTrainer">
              <mat-option value="">Sin asignar</mat-option>
              <mat-option *ngFor="let trainer of availableTrainers" 
                         [value]="trainer.uid">
                {{trainer.displayName}}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>
      </form>
    </mat-card-content>

    <mat-card-actions align="end">
      <button mat-button 
              type="button" 
              (click)="cancelCreateUser()">
        Cancelar
      </button>
      
      <button mat-raised-button 
              color="primary"
              [disabled]="createUserForm.invalid || isCreatingUser"
              (click)="createUser()">
        <mat-spinner diameter="20" *ngIf="isCreatingUser"></mat-spinner>
        <span *ngIf="!isCreatingUser">Crear Usuario</span>
        <span *ngIf="isCreatingUser">Creando...</span>
      </button>
    </mat-card-actions>
  </mat-card>
</div>